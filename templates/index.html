<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Tracking System</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='MAA_Logo 32x32.png') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        /* Multi-select Asset Names Styles */
        .asset-names-container {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-start;
            gap: 4px;
            padding: 2px;
            border: 2px solid #86b7fe;
            border-radius: 8px;
            background: #f8f9fa;
            min-height: 48px;
            transition: box-shadow 0.2s;
        }
        
        .selected-asset-names {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 2px;
        }
        
        .asset-name-tag {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(90deg, #007bff 60%, #0056b3 100%);
            color: #fff;
            border-radius: 18px;
            padding: 6px 14px 6px 12px;
            font-size: 15px;
            margin: 3px 4px 3px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            font-weight: 500;
            transition: background 0.2s, box-shadow 0.2s;
        }
        
        .asset-name-tag .asset-name-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 120px;
        }
        
        .asset-name-tag .remove-btn {
            background: none;
            border: none;
            color: #fff;
            margin-left: 10px;
            cursor: pointer;
            padding: 0 2px;
            font-size: 15px;
            line-height: 1;
            border-radius: 50%;
            transition: background 0.2s, color 0.2s;
        }
        
        .asset-name-tag .remove-btn:hover {
            background: #fff2;
            color: #ffc107;
        }
        
        .asset-name-input {
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
            flex: 1;
            min-width: 150px;
            background: transparent;
            font-size: 15px;
            padding: 6px 0 6px 6px;
        }
        
                    .asset-names-container:focus-within {
                border-color: #007bff;
                box-shadow: 0 0 0 0.15rem #007bff33;
            }
            
            .custom-dropdown {
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: white;
                border: 1px solid #ddd;
                border-radius: 4px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                max-height: 200px;
                overflow-y: auto;
                z-index: 1000;
                margin-top: 2px;
            }
            
            .dropdown-list {
                padding: 0;
                margin: 0;
            }
            
            .dropdown-item {
                padding: 8px 12px;
                cursor: pointer;
                border-bottom: 1px solid #f0f0f0;
                transition: background-color 0.2s;
            }
            
            .dropdown-item:hover {
                background-color: #f8f9fa;
            }
            
            .dropdown-item:last-child {
                border-bottom: none;
            }
            
            .asset-names-container {
                position: relative;
            }
        
        /* Dark Mode Styles */
        .dark-mode {
            background-color: #1a1a1a !important;
            color: #ffffff !important;
        }
        
        .dark-mode .card {
            background-color: #2d2d2d !important;
            border-color: #404040 !important;
        }
        
        .dark-mode .table {
            background-color: #2d2d2d !important;
            color: #ffffff !important;
        }
        
        .dark-mode .table thead th {
            background-color: #404040 !important;
            color: #ffffff !important;
            border-color: #555555 !important;
        }
        
        .dark-mode .table tbody td {
            border-color: #404040 !important;
        }
        
        .dark-mode .form-control,
        .dark-mode .form-select {
            background-color: #404040 !important;
            border-color: #555555 !important;
            color: #ffffff !important;
        }
        
        .dark-mode .form-control:focus,
        .dark-mode .form-select:focus {
            background-color: #404040 !important;
            border-color: #86b7fe !important;
            color: #ffffff !important;
        }
        
        .dark-mode .form-control.asset-name-input,
        .dark-mode input.form-control.asset-name-input {
            background-color: #404040 !important;
            border-color: #555555 !important;
            color: #ffffff !important;
        }
        
        .dark-mode .form-control.asset-name-input:focus,
        .dark-mode input.form-control.asset-name-input:focus {
            background-color: #404040 !important;
            border-color: #86b7fe !important;
            color: #ffffff !important;
        }
        
        .dark-mode .form-control.asset-name-input::placeholder,
        .dark-mode input.form-control.asset-name-input::placeholder {
            color: #b0b0b0 !important;
        }
        
        .dark-mode .asset-names-container {
            border-color: #555555 !important;
        }
        
        .dark-mode .asset-names-container:focus-within {
            border-color: #007bff !important;
            box-shadow: 0 0 0 0.15rem #007bff33 !important;
        }
        
        .dark-mode .custom-dropdown {
            background-color: #404040 !important;
            border-color: #555555 !important;
        }
        
        .dark-mode .dropdown-item {
            background-color: #404040 !important;
            color: #ffffff !important;
            border-bottom-color: #555555 !important;
        }
        
        .dark-mode .dropdown-item:hover {
            background-color: #555555 !important;
            color: #ffffff !important;
        }
        
        .dark-mode .btn {
            border-color: #555555 !important;
        }
        
        .dark-mode .btn-outline-secondary {
            color: #ffffff !important;
            border-color: #6c757d !important;
        }
        
        .dark-mode .btn-outline-secondary:hover {
            background-color: #6c757d !important;
            color: #ffffff !important;
        }
        
        .dark-mode .pagination .page-link {
            background-color: #404040 !important;
            border-color: #555555 !important;
            color: #ffffff !important;
        }
        
        .dark-mode .pagination .page-item.active .page-link {
            background-color: #007bff !important;
            border-color: #007bff !important;
        }
        
        .dark-mode .pagination .page-link:hover {
            background-color: #555555 !important;
            color: #ffffff !important;
        }
        
        .dark-mode .alert {
            background-color: #2d2d2d !important;
            border-color: #404040 !important;
        }
        
        .dark-mode .text-muted {
            color: #adb5bd !important;
        }
        
        /* System Value Text - Responsive to theme */
        .system-value-text {
            color: #000000 !important; /* Default dark text for light mode */
        }
        
        .dark-mode .system-value-text {
            color: #ffffff !important; /* White text for dark mode */
        }
        
        /* Admin Menu Button Styles */
        .admin-menu-button {
            position: absolute;
            left: 20px;
            top: 20px;
            z-index: 1000;
        }
        
        .menu-button {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            color: white;
        }
        
        .menu-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .menu-button i {
            font-size: 1.2em;
        }
        
        .admin-menu-dropdown {
            position: absolute;
            top: 60px;
            left: 0;
            background: linear-gradient(180deg, #2c3e50, #34495e);
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            min-width: 220px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .admin-menu-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .menu-header {
            padding: 15px 20px;
            border-bottom: 1px solid #34495e;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-weight: 600;
        }
        
        .menu-header i {
            font-size: 1.1em;
        }
        
        .menu-items {
            list-style: none;
            padding: 10px 0;
            margin: 0;
        }
        
        .menu-item {
            margin: 0;
        }
        
        .menu-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: #ecf0f1;
            text-decoration: none;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .menu-link:hover {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
            text-decoration: none;
        }
        
        .menu-link i {
            font-size: 1em;
            min-width: 16px;
            text-align: center;
        }
        
        /* Submenu Styles */
        .has-submenu {
            position: relative;
        }
        
        .submenu-trigger {
            justify-content: space-between;
        }
        
        .submenu-arrow {
            transition: transform 0.3s ease;
        }
        
        .has-submenu.open .submenu-arrow {
            transform: rotate(90deg);
        }
        
        .submenu {
            list-style: none;
            padding: 0;
            margin: 0;
            background: rgba(0, 0, 0, 0.1);
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .has-submenu.open .submenu {
            max-height: 300px;
        }
        
        .submenu-trigger:hover {
            background: rgba(52, 152, 219, 0.1);
        }
        
        .submenu-item {
            margin: 0;
        }
        
        .submenu-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 20px 10px 40px;
            color: #ecf0f1;
            text-decoration: none;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-size: 0.9em;
        }
        
        .submenu-link:hover {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
            text-decoration: none;
        }
        
        .submenu-link i {
            font-size: 0.9em;
            min-width: 14px;
            text-align: center;
        }
        
        /* Dark mode adjustments */
        .dark-mode .menu-button {
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
        }
        
        .dark-mode .admin-menu-dropdown {
            background: linear-gradient(180deg, #1a1a1a, #2d2d2d);
        }
        
        .dark-mode .menu-header {
            border-bottom-color: #404040;
        }
        
        /* Summary Statistics Styles */
        .stat-item {
            padding: 15px;
            border-radius: 8px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            transition: transform 0.2s ease;
        }
        
        .stat-item:hover {
            transform: translateY(-2px);
        }
        
        .stat-item h3 {
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .dark-mode .stat-item {
            background: linear-gradient(135deg, #2d2d2d, #404040);
        }
        

        
        /* Table Responsive Styles */
        .table-responsive {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            width: 100%;
            max-width: none;
        }
        
        .table {
            margin-bottom: 0;
        }
        
        .table th {
            white-space: nowrap;
            min-width: 100px;
        }
        
        .table th:first-child {
            min-width: 50px;
        }
        
        .table th:nth-child(2) {
            min-width: 60px;
        }
        
        .table th:nth-child(3) {
            min-width: 200px;
        }
        
        .table th:nth-child(4) {
            min-width: 120px;
        }
        
        .table th:nth-child(5) {
            min-width: 100px;
        }
        
        .table th:nth-child(6) {
            min-width: 120px;
        }
        
        .table th:nth-child(7) {
            min-width: 120px;
        }
        
        .table th:nth-child(8) {
            min-width: 120px;
        }
        
        .table th:nth-child(9) {
            min-width: 150px;
        }
        
        .table th:nth-child(10) {
            min-width: 120px;
        }
        
        .table th:nth-child(11) {
            min-width: 100px;
        }
        
                .table th:last-child {
            min-width: 100px;
        }
        
        .dark-mode .text-muted {
            color: #b0b0b0 !important;
        }
        
        .dark-mode .badge.bg-secondary {
            background-color: #6c757d !important;
        }
        
        .dark-mode .badge.bg-success {
            background-color: #28a745 !important;
        }
        
        .dark-mode .badge.bg-warning {
            background-color: #ffc107 !important;
            color: #000000 !important;
        }
        
        .dark-mode .badge.bg-danger {
            background-color: #dc3545 !important;
        }
        
        .dark-mode .badge.bg-info {
            background-color: #17a2b8 !important;
        }
        
        /* Pagination Text Styles */
        .pagination-text {
            color: #2c3e50;
            font-weight: 500;
        }
        
        .dark-mode .pagination-text {
            color: #ecf0f1;
        }
        
        /* Pagination Input Styles */
        .pagination-input {
            color: #2c3e50;
            background-color: #ffffff;
            border: 1px solid #ced4da;
        }
        
        .dark-mode .pagination-input {
            color: #ecf0f1;
            background-color: #2d2d2d;
            border-color: #404040;
        }
        
        /* Price Analysis Modal Filter Styles */
        .price-analysis-filter-label {
            color: #2c3e50;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .dark-mode .price-analysis-filter-label {
            color: #ecf0f1;
        }
        
        .price-analysis-filter-select {
            color: #2c3e50;
            background-color: #ffffff;
            border: 1px solid #ced4da;
        }
        
        .dark-mode .price-analysis-filter-select {
            color: #ecf0f1;
            background-color: #2d2d2d;
            border-color: #404040;
        }
        
        /* Modal Dark Mode Styles */
        .dark-mode .modal-content {
            background-color: #343a40 !important;
            border-color: #495057 !important;
            color: #e9ecef !important;
        }
        
        .dark-mode .modal-header {
            background-color: #495057 !important;
            border-bottom-color: #6c757d !important;
            color: #e9ecef !important;
        }
        
        .dark-mode .modal-footer {
            background-color: #495057 !important;
            border-top-color: #6c757d !important;
        }
        
        .dark-mode .modal-title {
            color: #e9ecef !important;
        }
        
        .dark-mode .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }
        
        /* Dropdown Dark Mode Styles */
        .dark-mode .dropdown-menu {
            background-color: #343a40 !important;
            border-color: #495057 !important;
            color: #e9ecef !important;
        }
        
        .dark-mode .dropdown-item {
            color: #e9ecef !important;
        }
        
        .dark-mode .dropdown-item:hover {
            background-color: #495057 !important;
            color: #fff !important;
        }
        
        .dark-mode .dropdown-item.active {
            background-color: #ffd700 !important;
            color: #000 !important;
        }
        
        /* Custom dropdown selection styles for both light and dark modes */
        .dropdown-item.selected {
            background-color: #007bff !important;
            color: white !important;
        }
        
        .dark-mode .dropdown-item.selected {
            background-color: #007bff !important;
            color: white !important;
        }
        
        /* Alert Dark Mode Styles */
        .dark-mode .alert-info {
            background-color: #1a4a5e !important;
            border-color: #17a2b8 !important;
            color: #b8e6f3 !important;
        }
        
        .dark-mode .alert-success {
            background-color: #1e4a2e !important;
            border-color: #28a745 !important;
            color: #b8f3c8 !important;
        }
        
        .dark-mode .alert-warning {
            background-color: #4a3e1a !important;
            border-color: #ffc107 !important;
            color: #ffeaa7 !important;
        }
        
        .dark-mode .alert-danger {
            background-color: #4a1e1e !important;
            border-color: #dc3545 !important;
            color: #f5b7b7 !important;
        }
        
        /* Form Validation Dark Mode */
        .dark-mode .is-valid {
            border-color: #28a745 !important;
            background-color: #1e4a2e !important;
        }
        
        .dark-mode .is-invalid {
            border-color: #dc3545 !important;
            background-color: #4a1e1e !important;
        }
        
        .dark-mode .valid-feedback {
            color: #b8f3c8 !important;
        }
        
        .dark-mode .invalid-feedback {
            color: #f5b7b7 !important;
        }
        
        /* Tooltip and Popover Dark Mode */
        .dark-mode .tooltip-inner {
            background-color: #343a40 !important;
            color: #e9ecef !important;
        }
        
        .dark-mode .popover {
            background-color: #343a40 !important;
            border-color: #495057 !important;
            color: #e9ecef !important;
        }
        
        .dark-mode .popover-header {
            background-color: #495057 !important;
            border-bottom-color: #6c757d !important;
            color: #e9ecef !important;
        }
        
        /* Loading Spinner Dark Mode */
        .dark-mode .spinner-border {
            color: #ffd700 !important;
        }
        
        .dark-mode .spinner-grow {
            color: #ffd700 !important;
        }
        
        /* QR Code Styles - Matching Archive */
        .qr-code-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .qr-code-img {
            transition: transform 0.2s ease;
        }
        
        .qr-code-img:hover {
            transform: scale(1.1);
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
            border-color: #FFD700;
        }
        
        /* Print Styles for Thermal Printer QR Codes */
        @media print {
            body {
                margin: 0;
                padding: 0;
                background: white;
            }
            
            .modal-header,
            .modal-footer,
            .btn,
            .form-control,
            .form-select {
                display: none !important;
            }
            
            .modal-content {
                border: none !important;
                box-shadow: none !important;
                background: white !important;
            }
            
            .modal-body {
                padding: 0 !important;
                overflow: visible !important;
                max-height: none !important;
            }
            
            #bulkQrHeader {
                display: none !important;
            }
            
            .row.mb-3 {
                display: none !important;
            }
            
            .thermal-page {
                page-break-after: always !important;
                page-break-inside: avoid !important;
                margin: 0 !important;
                padding: 20px !important;
                border: none !important;
                background: white !important;
                min-height: 100vh !important;
                display: flex !important;
                flex-direction: column !important;
                justify-content: center !important;
                align-items: center !important;
            }
            
            .thermal-page:last-child {
                page-break-after: auto !important;
            }
            
            .qr-code-img {
                border: 2px solid #000 !important;
                background: white !important;
                margin-bottom: 20px !important;
            }
            
            .qr-code-container {
                text-align: center !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: center !important;
            }
        }
    </style>
</head>
<body>
        <!-- Admin Menu Button -->
        {% if current_user.role == 'admin' %}
        <div class="admin-menu-button" id="adminMenuButton">
            <div class="menu-button" onclick="toggleAdminMenu()">
                <i class="fas fa-bars"></i>
            </div>
            <div class="admin-menu-dropdown" id="adminMenuDropdown">
                <div class="menu-header">
                    <i class="fas fa-cogs"></i>
                    <span>Admin Menu</span>
                </div>
                <ul class="menu-items">
                    <li class="menu-item has-submenu">
                        <a href="#" class="menu-link submenu-trigger">
                            <i class="fas fa-users"></i>
                            <span>Users</span>
                            <i class="fas fa-chevron-right submenu-arrow"></i>
                        </a>
                        <ul class="submenu">
                            <li class="submenu-item">
                                <a href="{{ url_for('auth.manage_users') }}" class="submenu-link">
                                    <i class="fas fa-user-cog"></i>
                                    <span>Manage Users</span>
                                </a>
                            </li>
                            <li class="submenu-item">
                                <a href="{{ url_for('auth.add_auth_user') }}" class="submenu-link">
                                    <i class="fas fa-user-plus"></i>
                                    <span>Add User</span>
                                </a>
                            </li>
                        </ul>
                    </li>
                    <li class="menu-item has-submenu">
                        <a href="#" class="menu-link submenu-trigger">
                            <i class="fas fa-tools"></i>
                            <span>Manage</span>
                            <i class="fas fa-chevron-right submenu-arrow"></i>
                        </a>
                        <ul class="submenu">
                            <li class="submenu-item">
                                <a href="#" class="submenu-link" data-bs-toggle="modal" data-bs-target="#buildingManagementModal">
                                    <i class="fas fa-building"></i>
                                    <span>Manage Buildings</span>
                                </a>
                            </li>
                            <li class="submenu-item">
                                <a href="#" class="submenu-link" data-bs-toggle="modal" data-bs-target="#departmentManagementModal">
                                    <i class="fas fa-sitemap"></i>
                                    <span>Manage Departments</span>
                                </a>
                            </li>
                            <li class="submenu-item">
                                <a href="#" class="submenu-link" data-bs-toggle="modal" data-bs-target="#userManagementModal">
                                    <i class="fas fa-user-tie"></i>
                                    <span>Manage Employees</span>
                                </a>
                            </li>
                            <li class="submenu-item">
                                <a href="#" class="submenu-link" data-bs-toggle="modal" data-bs-target="#assetManagementModal">
                                    <i class="fas fa-boxes"></i>
                                    <span>Manage Assets</span>
                                </a>
                            </li>
                        </ul>
                    </li>
                    <li class="menu-item">
                        <a href="{{ url_for('assets.archive') }}" class="menu-link">
                            <i class="fas fa-archive"></i>
                            <span>Asset Archive</span>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="#" class="menu-link" data-bs-toggle="modal" data-bs-target="#priceAnalysisModal">
                            <i class="fas fa-coins"></i>
                            <span>View Price Analysis</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        

        {% endif %}

<div class="container-fluid mt-5 px-4">
    <div class="header-logo">
        <img src="{{ url_for('static', filename='MAA_Logo.png') }}" alt="MAA Group Logo">
        <h1>Asset Tracking System</h1>
        <div class="gold-divider"></div>
    </div>

    <!-- User Info and Logout -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center">
                <div class="user-info">
                    <span class="badge me-2" style="background: #ffd700; color: #000000;">
                        <i class="fas fa-user"></i> {{ current_user.username }}
                    </span>
                    <span class="badge" style="background: #333333; color: #ffd700;">
                        <i class="fas fa-shield-alt"></i> {{ current_user.role|title }}
                    </span>
                </div>
                <div class="logout-section">
                    <!-- Dark Mode Toggle -->
                    <button id="darkModeToggle" class="btn btn-sm me-2" type="button" onclick="toggleDarkMode()" style="border-color: #6c757d; color: #6c757d; background: rgba(255,255,255,0.9); z-index: 1000;">
                        <i class="fas fa-moon"></i><span> Dark Mode</span>
                    </button>
                    <a href="{{ url_for('auth.logout') }}" class="btn btn-sm" style="border-color: #dc3545; color: #dc3545;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="row mb-3">
                <div class="col-md-12">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    {% endwith %}





    <!-- Summary Statistics -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-line"></i> System Overview</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="stat-item">
                                <h3 class="text-primary">{{ chart_data.total_system_value|round(3) }}</h3>
                                <p class="text-muted mb-0">Total System Value (OMR)</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-item">
                                <h3 class="text-success">{{ total_assets }}</h3>
                                <p class="text-muted mb-0">Total Assets</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-item">
                                <h3 class="text-info">{{ chart_data.building_counts|length }}</h3>
                                <p class="text-muted mb-0">Buildings</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-item">
                                <h3 class="text-warning">{{ chart_data.department_counts|length }}</h3>
                                <p class="text-muted mb-0">Departments</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>





    <!-- Advanced Search and Filters -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-search"></i> Search & Filters</h5>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-success btn-sm" id="addAssetBtn" data-bs-toggle="modal" data-bs-target="#addAssetModal">
                    <i class="fas fa-plus"></i> Add Asset
                </button>
                <button type="button" class="btn btn-info btn-sm" id="departmentQRBtn" data-bs-toggle="modal" data-bs-target="#departmentQRModal">
                    <i class="fas fa-qrcode"></i> QR Codes
                </button>
            </div>
        </div>
        <div class="card-body">
            <form method="get" id="searchForm">
                <!-- Search Row -->
                <div class="row mb-3">
                    <div class="col-md-8">
                        <label for="globalSearch" class="form-label">Global Search</label>
                        <div class="input-group">
                        <input type="text" class="form-control" id="globalSearch" name="search" 
                               value="{{ request.args.get('search', '') }}" 
                               placeholder="Search names, owners, codes, asset types, etc...">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i> Search
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                                <i class="fas fa-times"></i> Clear
                            </button>
                    </div>
                    </div>
                    <div class="col-md-4">
                        <label for="itemsPerPage" class="form-label">Items per Page</label>
                        <select class="form-select" id="itemsPerPage" name="per_page">
                            <option value="10" {% if request.args.get('per_page') == '10' %}selected{% endif %}>10 items</option>
                            <option value="25" {% if request.args.get('per_page') == '25' %}selected{% endif %}>25 items</option>
                            <option value="50" {% if request.args.get('per_page') == '50' %}selected{% endif %}>50 items</option>
                            <option value="100" {% if request.args.get('per_page') == '100' %}selected{% endif %}>100 items</option>
                        </select>
                    </div>
                </div>
                
                <!-- Filters Row -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="building" class="form-label">Building</label>
                        <select class="form-select" id="buildingFilter" name="building">
                            <option value="">All Buildings</option>
                            {% for b in buildings %}
                                <option value="{{ b }}" {% if b == building_filter %}selected{% endif %}>{{ b }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="department" class="form-label">Department</label>
                        <select class="form-select" id="departmentFilter" name="department">
                            <option value="">All Departments</option>
                            {% for d in departments %}
                                <option value="{{ d }}" {% if d == department_filter %}selected{% endif %}>{{ d }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="statusFilter" class="form-label">Status</label>
                        <select class="form-select" id="statusFilter" name="status">
                            <option value="">All Status</option>
                            <option value="Used" {% if request.args.get('status') == 'Used' %}selected{% endif %}>Used</option>
                            <option value="Not Used" {% if request.args.get('status') == 'Not Used' %}selected{% endif %}>Not Used</option>
                            <option value="Out of Service" {% if request.args.get('status') == 'Out of Service' %}selected{% endif %}>Out of Service</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="assetTypeFilter" class="form-label">Asset Type</label>
                        <select class="form-select" id="assetTypeFilter" name="asset_type">
                            <option value="">All Types</option>
                        </select>
                    </div>
                </div>
                

                
                <input type="hidden" name="sort_by" value="{{ sort_by }}">
                <input type="hidden" name="sort_dir" value="{{ sort_dir }}">
            </form>
        </div>
    </div>

    <form class="filters-row" method="get" id="filterForm" style="display: none;">
        <!-- Hidden form for backward compatibility -->
    </form>
    
    <!-- Bulk Actions Bar -->
    <div id="bulkActionsBar" class="alert alert-primary border-primary mb-3" style="display: none;">
        <div class="d-flex justify-content-between align-items-center">
            <span><i class="fas fa-info-circle"></i> <strong><span id="selectedCount">0</span> items selected</strong> - Use the buttons to perform actions on selected items</span>
            <div>
                <button class="btn btn-info btn-sm me-2" id="bulkPrintQrBtn">
                    <i class="fas fa-qrcode"></i> Print QR Codes
                </button>
                <button class="btn btn-warning btn-sm me-2" id="bulkUpdateStatusBtn">
                    <i class="fas fa-edit"></i> Update Status
                </button>
                <button class="btn btn-danger btn-sm me-2" id="bulkDeleteBtn">
                    <i class="fas fa-trash"></i> Delete Selected
                </button>
                <button class="btn btn-outline-secondary btn-sm" id="clearSelectionBtn">
                    <i class="fas fa-times"></i> Clear Selection
                </button>
            </div>
        </div>
    </div>
    
    <div class="table-responsive">
        <table class="table table-bordered table-striped" style="width: 100%; min-width: 1400px;">
        <thead>
            <tr>
                <th><input type="checkbox" id="selectAllCheckbox" title="Select All"></th>
                <th>#</th>
                <th><a href="?sort_by=name&sort_dir={{ 'desc' if sort_by == 'name' and sort_dir == 'asc' else 'asc' }}&building={{ building_filter }}&department={{ department_filter }}&search={{ request.args.get('search', '') }}&status={{ request.args.get('status', '') }}&asset_type={{ request.args.get('asset_type', '') }}&per_page={{ request.args.get('per_page', '10') }}">Name{% if sort_by == 'name' %} {% if sort_dir == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</a></th>
                <th><a href="?sort_by=asset_type&sort_dir={{ 'desc' if sort_by == 'asset_type' and sort_dir == 'asc' else 'asc' }}&building={{ building_filter }}&department={{ department_filter }}&search={{ request.args.get('search', '') }}&status={{ request.args.get('status', '') }}&asset_type={{ request.args.get('asset_type', '') }}&per_page={{ request.args.get('per_page', '10') }}">Type{% if sort_by == 'asset_type' %} {% if sort_dir == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</a></th>
                <th><a href="?sort_by=quantity&sort_dir={{ 'desc' if sort_by == 'quantity' and sort_dir == 'asc' else 'asc' }}&building={{ building_filter }}&department={{ department_filter }}&search={{ request.args.get('search', '') }}&status={{ request.args.get('status', '') }}&per_page={{ request.args.get('per_page', '10') }}">Quantity{% if sort_by == 'quantity' %} {% if sort_dir == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</a></th>
                <th><a href="?sort_by=price&sort_dir={{ 'desc' if sort_by == 'price' and sort_dir == 'asc' else 'asc' }}&building={{ building_filter }}&department={{ department_filter }}&search={{ request.args.get('search', '') }}&status={{ request.args.get('status', '') }}&per_page={{ request.args.get('per_page', '10') }}">Total Value (OMR){% if sort_by == 'price' %} {% if sort_dir == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</a></th>
                <th><a href="?sort_by=owner&sort_dir={{ 'desc' if sort_by == 'owner' and sort_dir == 'asc' else 'asc' }}&building={{ building_filter }}&department={{ department_filter }}&search={{ request.args.get('search', '') }}&status={{ request.args.get('status', '') }}&per_page={{ request.args.get('per_page', '10') }}">Owner{% if sort_by == 'owner' %} {% if sort_dir == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</a></th>
                <th><a href="?sort_by=building&sort_dir={{ 'desc' if sort_by == 'building' and sort_dir == 'asc' else 'asc' }}&building={{ building_filter }}&department={{ department_filter }}&search={{ request.args.get('search', '') }}&status={{ request.args.get('status', '') }}&per_page={{ request.args.get('per_page', '10') }}">Building{% if sort_by == 'building' %} {% if sort_dir == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</a></th>
                <th><a href="?sort_by=department&sort_dir={{ 'desc' if sort_by == 'department' and sort_dir == 'asc' else 'asc' }}&building={{ building_filter }}&department={{ department_filter }}&search={{ request.args.get('search', '') }}&status={{ request.args.get('status', '') }}&per_page={{ request.args.get('per_page', '10') }}">Department/Section{% if sort_by == 'department' %} {% if sort_dir == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</a></th>
                <th><a href="?sort_by=used_status&sort_dir={{ 'desc' if sort_by == 'used_status' and sort_dir == 'asc' else 'asc' }}&building={{ building_filter }}&department={{ department_filter }}&search={{ request.args.get('search', '') }}&status={{ request.args.get('status', '') }}&per_page={{ request.args.get('per_page', '10') }}">Status{% if sort_by == 'used_status' %} {% if sort_dir == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</a></th>
                <th>QR CODE</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
        {% for asset in assets %}
            <tr>
                <td><input type="checkbox" class="asset-checkbox" data-asset-id="{{ asset.id }}" data-asset-name="{{ asset.name }}"></td>
                <td>{{ loop.index + (page-1)*per_page }}</td>
                <td>
                    <strong>{{ asset.name }}</strong>
                    <br><small class="text-muted">{{ asset.asset_code }}</small>
                </td>
                <td>
                    {% if asset.asset_type %}
                        <span class="badge bg-info">{{ asset.asset_type }}</span>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>{{ asset.quantity }}</td>
                <td>
                    <div class="d-flex flex-column">
                        <span class="fw-bold">OMR {{ "%.3f"|format((asset.price or 0.0) * asset.quantity) }}</span>
                        <small class="text-muted">({{ "%.3f"|format(asset.price or 0.0) }} × {{ asset.quantity }})</small>
                    </div>
                </td>
                <td>{{ asset.owner }}</td>
                <td>{{ asset.building }}</td>
                <td>{{ asset.department }}</td>
                <td>
                    <select class="form-select form-select-sm status-select" data-asset-id="{{ asset.id }}" style="min-width: 120px;">
                        <option value="Used" {% if asset.used_status == 'Used' %}selected{% endif %}>Used</option>
                        <option value="Not Used" {% if asset.used_status == 'Not Used' %}selected{% endif %}>Not Used</option>
                        <option value="Out of Service" {% if asset.used_status == 'Out of Service' %}selected{% endif %}>Out of Service</option>
                    </select>
                </td>
                <td class="text-center">
                    {% if asset.asset_code %}
                        <div class="qr-code-container">
                            <img src="/assets/qrcode/{{ asset.id }}"  
                                 alt="QR Code for {{ asset.name }}" 
                                 class="qr-code-img" 
                                 style="width: 60px; height: 60px; cursor: pointer;"
                                 onclick="showQRModal('{{ asset.id }}', '{{ asset.asset_code }}', '{{ asset.name }}')"
                                 title="Click to view larger QR code">
                            <div class="qr-code-text" style="font-size: 0.7em; color: #6c757d; margin-top: 2px; word-break: break-all;">
                                {{ asset.asset_code }}
                            </div>
                        </div>
                    {% else %}
                        <span class="text-muted">N/A</span>
                    {% endif %}
                </td>
                <td>
                    <button class="btn btn-primary btn-sm edit-asset-btn" 
                            data-asset-id="{{ asset.id }}"
                            data-asset-name="{{ asset.name }}"
                            data-asset-type="{{ asset.asset_type or '' }}"
                            data-asset-quantity="{{ asset.quantity }}"
                            data-asset-price="{{ asset.price or 0.0 }}"
                            data-asset-owner="{{ asset.owner }}"
                            data-asset-building="{{ asset.building }}"
                            data-asset-department="{{ asset.department }}"
                            data-asset-status="{{ asset.used_status }}"
                            data-bs-toggle="modal" 
                            data-bs-target="#editAssetModal">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    </div>

<!-- Enhanced Pagination controls -->
<nav aria-label="Page navigation">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <span class="text-muted">
                Showing {{ (page-1)*per_page + 1 }} to {{ [page*per_page, total_assets]|min }} of {{ total_assets }} assets
            </span>
        </div>
        <div class="d-flex align-items-center">
                                    <span class="me-3 pagination-text">Jump to page:</span>
                          <input type="number" id="jumpToPage" class="form-control me-2 pagination-input" style="width: 80px;" 
                     min="1" max="{{ total_pages }}" value="{{ page }}"  
                   onkeypress="if(event.key==='Enter') jumpToPage()">
            <span class="text-muted">of {{ total_pages }}</span>
        </div>
    </div>
  <ul class="pagination justify-content-center">
    <li class="page-item {% if page == 1 %}disabled{% endif %}">
            <a class="page-link" href="?page=1&sort_by={{ sort_by }}&sort_dir={{ sort_dir }}&building={{ building_filter }}&department={{ department_filter }}&search={{ request.args.get('search', '') }}&status={{ request.args.get('status', '') }}&per_page={{ request.args.get('per_page', '10') }}">
                <i class="fas fa-angle-double-left"></i>
            </a>
    </li>
        <li class="page-item {% if page == 1 %}disabled{% endif %}">
            <a class="page-link" href="?page={{ page - 1 if page > 1 else 1 }}&sort_by={{ sort_by }}&sort_dir={{ sort_dir }}&building={{ building_filter }}&department={{ department_filter }}&search={{ request.args.get('search', '') }}&status={{ request.args.get('status', '') }}&per_page={{ request.args.get('per_page', '10') }}">
                <i class="fas fa-angle-left"></i>
            </a>
        </li>
        
        {% set start_page = [1, page - 2]|max %}
        {% set end_page = [total_pages, page + 2]|min %}
        
        {% if start_page > 1 %}
            <li class="page-item">
                <a class="page-link" href="?page=1&sort_by={{ sort_by }}&sort_dir={{ sort_dir }}&building={{ building_filter }}&department={{ department_filter }}&search={{ request.args.get('search', '') }}&status={{ request.args.get('status', '') }}&per_page={{ request.args.get('per_page', '10') }}">1</a>
    </li>
            {% if start_page > 2 %}
                <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
        {% endif %}
        
        {% for p in range(start_page, end_page + 1) %}
      <li class="page-item {% if p == page %}active{% endif %}">
                <a class="page-link" href="?page={{ p }}&sort_by={{ sort_by }}&sort_dir={{ sort_dir }}&building={{ building_filter }}&department={{ department_filter }}&search={{ request.args.get('search', '') }}&status={{ request.args.get('status', '') }}&per_page={{ request.args.get('per_page', '10') }}">{{ p }}</a>
      </li>
    {% endfor %}
        
        {% if end_page < total_pages %}
            {% if end_page < total_pages - 1 %}
                <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
            <li class="page-item">
                <a class="page-link" href="?page={{ total_pages }}&sort_by={{ sort_by }}&sort_dir={{ sort_dir }}&building={{ building_filter }}&department={{ department_filter }}&search={{ request.args.get('search', '') }}&status={{ request.args.get('status', '') }}&per_page={{ request.args.get('per_page', '10') }}">{{ total_pages }}</a>
            </li>
        {% endif %}
        
    <li class="page-item {% if page == total_pages %}disabled{% endif %}">
            <a class="page-link" href="?page={{ page + 1 if page < total_pages else total_pages }}&sort_by={{ sort_by }}&sort_dir={{ sort_dir }}&building={{ building_filter }}&department={{ department_filter }}&search={{ request.args.get('search', '') }}&status={{ request.args.get('status', '') }}&per_page={{ request.args.get('per_page', '10') }}">
                <i class="fas fa-angle-right"></i>
            </a>
        </li>
    <li class="page-item {% if page == total_pages %}disabled{% endif %}">
            <a class="page-link" href="?page={{ total_pages }}&sort_by={{ sort_by }}&sort_dir={{ sort_dir }}&building={{ building_filter }}&department={{ department_filter }}&search={{ request.args.get('search', '') }}&status={{ request.args.get('status', '') }}&per_page={{ request.args.get('per_page', '10') }}">
                <i class="fas fa-angle-double-right"></i>
            </a>
    </li>
  </ul>
</nav>
</div>

<!-- Add Asset Modal -->
<div class="modal fade" id="addAssetModal" tabindex="-1" aria-labelledby="addAssetModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" style="max-width: 70%;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addAssetModalLabel">Add New Asset</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
                            <form id="addAssetForm" method="post" action="{{ url_for('assets.add_asset') }}">
        <div class="modal-body" style="overflow-y: auto; max-height: 70vh;">
          <div class="alert alert-info mb-3">
            <i class="fas fa-info-circle"></i> 
            <strong>Need to add buildings, departments, users, or asset names?</strong> 
            Use the management buttons on the main page to set up your infrastructure first. You can select multiple asset names from the same asset type. Each selected asset name will be added as a separate asset in the table. Asset names must be predefined in the "Manage Assets" section.
          </div>
            <div class="mb-3">
                <label for="asset_type" class="form-label">Asset Type</label>
                <select class="form-select" id="asset_type" name="asset_type" required>
                    <option value="">Select Asset Type</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="name" class="form-label">Asset Names</label>
                <div class="asset-names-container" id="assetNamesContainer">
                    <div class="selected-asset-names" id="selectedAssetNames"></div>
                    <input type="text" class="form-control asset-name-input" id="name" name="name" placeholder="Click to select asset names..." autocomplete="off">
                    <div class="custom-dropdown" id="assetNameDropdown" style="display: none;">
                        <div class="dropdown-list" id="assetNameList"></div>
                    </div>
                </div>
                <input type="hidden" id="selectedAssetNamesInput" name="selected_asset_names" value="">
            </div>
            <div class="mb-3">
                <label for="quantity" class="form-label">Quantity</label>
                <input type="number" class="form-control" id="quantity" name="quantity" min="1" value="1" required>
            </div>
            <div class="mb-3">
                <label for="price" class="form-label">Price (OMR)</label>
                <input type="number" class="form-control" id="price" name="price" min="0" step="0.01" placeholder="0.00" required>
                <div class="form-text">
                    <i class="fas fa-info-circle"></i> Enter the price in Omani Rial (OMR)
                </div>
            </div>
            <div class="mb-3">
                <label for="building" class="form-label">Building</label>
                <select class="form-select" id="building" name="building" required>
                    <option value="">Select Building</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="department" class="form-label">Department/Section</label>
                <select class="form-select" id="department" name="department" required>
                    <option value="">Select Building First</option>
                </select>
            </div>
            <div class="mb-3">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="noOwnerCheck" name="no_owner">
                    <label class="form-check-label" for="noOwnerCheck">
                        <i class="fas fa-user-slash"></i> No Owner Required
                    </label>
                </div>
                <label for="owner" class="form-label">Owner</label>
                <select class="form-select" id="owner" name="owner" required>
                    <option value="">Select Department First</option>
                </select>
                <div class="form-text" id="ownerHelp">
                    <i class="fas fa-info-circle"></i> Select "No Owner Required" for shared assets or when no specific owner is needed
                </div>
            </div>
            <div class="mb-3">
                <label for="used_status" class="form-label">Status</label>
                <select class="form-select" id="used_status" name="used_status" required>
                    <option value="Used">Used</option>
                    <option value="Not Used">Not Used</option>
                    <option value="Out of Service">Out of Service</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Add Asset</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Asset Modal -->
<div class="modal fade" id="editAssetModal" tabindex="-1" aria-labelledby="editAssetModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editAssetModalLabel">Edit Asset</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editAssetForm" method="post">
        <div class="modal-body" style="overflow-y: auto; max-height: 70vh;">
          <div class="alert alert-info mb-3">
            <i class="fas fa-info-circle"></i> 
            <strong>Editing Asset:</strong> 
            <span id="editAssetName"></span>
          </div>
            <div class="mb-3">
                <label for="edit_asset_type" class="form-label">Asset Type</label>
                <select class="form-select" id="edit_asset_type" name="asset_type" required>
                    <option value="">Select Asset Type</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="edit_name" class="form-label">Asset Name</label>
                <input type="text" class="form-control" id="edit_name" name="name" list="editAssetNameList" placeholder="Select Asset Type First" required autocomplete="off">
                <datalist id="editAssetNameList">
                    <option value="">Select Asset Type First</option>
                </datalist>
            </div>
            <div class="mb-3">
                <label for="edit_quantity" class="form-label">Quantity</label>
                <input type="number" class="form-control" id="edit_quantity" name="quantity" min="1" value="1" required>
            </div>
            <div class="mb-3">
                <label for="edit_price" class="form-label">Price (OMR)</label>
                <input type="number" class="form-control" id="edit_price" name="price" min="0" step="0.01" placeholder="0.00" required>
                <div class="form-text">
                    <i class="fas fa-info-circle"></i> Enter the price in Omani Rial (OMR)
                </div>
            </div>
            <div class="mb-3">
                <label for="edit_building" class="form-label">Building</label>
                <select class="form-select" id="edit_building" name="building" required>
                    <option value="">Select Building</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="edit_department" class="form-label">Department/Section</label>
                <select class="form-select" id="edit_department" name="department" required>
                    <option value="">Select Building First</option>
                </select>
            </div>
            <div class="mb-3">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="edit_noOwnerCheck" name="no_owner">
                    <label class="form-check-label" for="edit_noOwnerCheck">
                        <i class="fas fa-user-slash"></i> No Owner Required
                    </label>
                </div>
                <label for="edit_owner" class="form-label">Owner</label>
                <select class="form-select" id="edit_owner" name="owner" required>
                    <option value="">Select Department First</option>
                </select>
                <div class="form-text" id="edit_ownerHelp">
                    <i class="fas fa-info-circle"></i> Select "No Owner Required" for shared assets or when no specific owner is needed
                </div>
            </div>
            <div class="mb-3">
                <label for="edit_used_status" class="form-label">Status</label>
                <select class="form-select" id="edit_used_status" name="used_status" required>
                    <option value="Used">Used</option>
                    <option value="Not Used">Not Used</option>
                    <option value="Out of Service">Out of Service</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Update Asset</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- QR Code Modal -->
<div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" style="max-width: 70%;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="qrModalLabel">Asset QR Code</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center" id="qrModalBody" style="padding: 30px;">
        <!-- For image-based QR codes -->
        <div class="qr-code-wrapper" style="display: flex; justify-content: center; align-items: center; margin-bottom: 20px;">
          <img id="qrModalImage" src="" alt="QR Code" style="width: 250px; height: 250px; object-fit: contain; border: 2px solid #d1b173; border-radius: 8px;">
        </div>
        <div class="fw-bold mt-3" id="qrModalAssetName" style="font-size: 1.2em; color: #333;"></div>
        <div class="text-muted" id="qrModalAssetCode" style="font-size: 1em; color: #666;"></div>
        <button class="btn btn-primary mt-4" id="printQrBtn">Print QR Code</button>
        
        <!-- For legacy JavaScript-generated QR codes -->
        <div id="qrcode" style="display: none;"></div>
        <div class="fw-bold mt-2" id="qrCodeLabel" style="display: none;"></div>
      </div>
    </div>
  </div>
</div>

<!-- Building Management Modal -->
<div class="modal fade" id="buildingManagementModal" tabindex="-1" aria-labelledby="buildingManagementModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" style="max-width: 70%;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="buildingManagementModalLabel">Manage Buildings</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="overflow-y: auto; max-height: 70vh;">
        <!-- Add New Building Form -->
        <div class="mb-4">
          <h6>Add New Building</h6>
          <div class="input-group">
            <input type="text" class="form-control" id="newBuildingName" placeholder="Enter building name" maxlength="100">
            <button class="btn btn-success" type="button" id="addBuildingBtn">Add</button>
          </div>
        </div>
        
        <!-- Buildings List -->
        <div>
          <h6>Existing Buildings</h6>
          <div id="buildingsList" class="list-group" style="max-height: 400px; overflow-y: auto;">
            <!-- Buildings will be loaded here -->
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Department & User Management Modal -->
<div class="modal fade" id="departmentManagementModal" tabindex="-1" aria-labelledby="departmentManagementModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl" style="max-width: 90%; max-height: 90vh;">
    <div class="modal-content" style="height: 90vh;">
      <div class="modal-header">
        <h5 class="modal-title" id="departmentManagementModalLabel">Manage Departments & Users</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="overflow-y: auto; max-height: calc(90vh - 120px);">
        <!-- Departments Management -->
        <div class="mt-3">
            <div class="mt-3">
              <!-- Add New Department Form -->
              <div class="mb-4">
                <h6>Add New Department</h6>
                <div class="row">
                  <div class="col-md-4">
                    <select class="form-select" id="newDepartmentBuilding" required>
                      <option value="">Select Building</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <input type="text" class="form-control" id="newDepartmentName" placeholder="Enter department name" maxlength="100">
                  </div>
                  <div class="col-md-2">
                    <button class="btn btn-success w-100" type="button" id="addDepartmentBtn">Add</button>
                  </div>
                </div>
              </div>
              
              <!-- Departments List -->
              <div>
                <h6>Existing Departments</h6>
                <div class="mb-3">
                  <label for="departmentFilterBuilding" class="form-label">Filter by Building:</label>
                  <select class="form-select" id="departmentFilterBuilding">
                    <option value="">All Buildings</option>
                  </select>
                </div>
                <div id="departmentsList" class="list-group" style="max-height: 400px; overflow-y: auto;">
                  <!-- Departments will be loaded here -->
                </div>
              </div>
            </div>
          </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Department QR Codes Modal -->
<div class="modal fade" id="departmentQRModal" tabindex="-1" aria-labelledby="departmentQRModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl" style="max-width: 85%; max-height: 90vh;">
    <div class="modal-content" style="height: 90vh;">
      <div class="modal-header">
        <h5 class="modal-title" id="departmentQRModalLabel">Department QR Codes</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="overflow-y: auto; max-height: calc(90vh - 120px);">
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i>
          <strong>Department QR Codes:</strong> Each QR code shows all items for that specific department and building combination.
        </div>
        <div id="departmentQRList" class="row">
          <!-- Department QR codes will be loaded here -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" id="exportDepartmentQRPdfBtn">
          <i class="fas fa-file-pdf"></i> Export to PDF
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Individual Department QR Code Modal -->
<div class="modal fade" id="individualDepartmentQRModal" tabindex="-1" aria-labelledby="individualDepartmentQRModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="individualDepartmentQRModalLabel">Department QR Code</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="individualDepartmentQRImage" src="" alt="Department QR Code" style="max-width: 100%; height: auto; border: 2px solid #d1b173; border-radius: 4px;">
        <div class="mt-3">
          <div id="individualDepartmentQRName" class="fw-bold" style="font-size: 1.2em; color: #333;"></div>
          <div id="individualDepartmentQRCode" class="text-muted" style="font-size: 1em; color: #666;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" id="printIndividualDepartmentQRBtn">
          <i class="fas fa-print"></i> Print QR Code
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- User Management Modal (for Owner field) -->
<div class="modal fade" id="userManagementModal" tabindex="-1" aria-labelledby="userManagementModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl" style="max-width: 90%; max-height: 90vh;">
    <div class="modal-content" style="height: 90vh;">
      <div class="modal-header">
        <h5 class="modal-title" id="userManagementModalLabel">
          <i class="fas fa-users"></i> User Management
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="overflow-y: auto; max-height: calc(90vh - 120px);">
        <!-- Register New User Form -->
        <div class="mb-4">
          <h6><i class="fas fa-user-plus"></i> Register New User</h6>
          <div class="row mb-2">
            <div class="col-md-4">
              <label for="userModalBuilding" class="form-label">Building</label>
              <select class="form-select" id="userModalBuilding" required>
                <option value="">Select Building</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="userModalDepartment" class="form-label">Department</label>
              <select class="form-select" id="userModalDepartment" required>
                <option value="">Select Building First</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="userModalName" class="form-label">Name</label>
              <input type="text" class="form-control" id="userModalName" placeholder="Enter user name" maxlength="100" required>
            </div>
          </div>
          <div class="row">
            <div class="col-12">
              <button class="btn btn-success" type="button" id="addUserModalBtn">
                <i class="fas fa-user-plus"></i> Register User
              </button>
            </div>
          </div>
        </div>
        
        <!-- Bulk Add Users Form -->
        <div class="mb-4">
          <h6><i class="fas fa-users"></i> Bulk Add Users</h6>
          <div class="row mb-2">
            <div class="col-md-6">
              <label for="bulkUserModalBuilding" class="form-label">Building</label>
              <select class="form-select" id="bulkUserModalBuilding" required>
                <option value="">Select Building</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="bulkUserModalDepartment" class="form-label">Department</label>
              <select class="form-select" id="bulkUserModalDepartment" required>
                <option value="">Select Building First</option>
              </select>
            </div>
          </div>
          <div class="row mb-2">
            <div class="col-12">
              <label for="bulkUserNames" class="form-label">User Names (one per line)</label>
              <textarea class="form-control" id="bulkUserNames" rows="5" placeholder="Enter user names, one per line&#10;Example:&#10;John Doe&#10;Jane Smith&#10;Mike Johnson"></textarea>
            </div>
          </div>
          <div class="row">
            <div class="col-12">
              <button class="btn btn-primary" type="button" id="addBulkUsersModalBtn">
                <i class="fas fa-users"></i> Add Multiple Users
              </button>
            </div>
          </div>
        </div>
        
        <hr>
        
        <!-- Users List -->
        <div>
          <h6><i class="fas fa-list"></i> Existing Users</h6>
          <div class="mb-3">
            <label for="userModalFilterDepartment" class="form-label">Filter by Department:</label>
            <select class="form-select" id="userModalFilterDepartment">
              <option value="">All Departments</option>
            </select>
          </div>
          <div id="userModalList" class="list-group" style="max-height: 400px; overflow-y: auto;">
            <!-- Users will be loaded here -->
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Asset Management Modal -->
<div class="modal fade" id="assetManagementModal" tabindex="-1" aria-labelledby="assetManagementModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl" style="max-width: 90%; max-height: 90vh;">
    <div class="modal-content" style="height: 90vh;">
      <div class="modal-header">
        <h5 class="modal-title" id="assetManagementModalLabel">
          <i class="fas fa-boxes"></i> Manage Asset Types & Names
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="overflow-y: auto; max-height: calc(90vh - 120px);">
        <!-- Asset Types Management -->
        <div class="mb-4">
          <h6><i class="fas fa-tags"></i> Asset Types Management</h6>
          <!-- Add New Asset Type Form -->
          <div class="mb-3">
            <div class="row">
              <div class="col-md-8">
                <input type="text" class="form-control" id="newAssetTypeName" placeholder="Enter asset type name" maxlength="100">
              </div>
              <div class="col-md-4">
                <button class="btn btn-success w-100" type="button" id="addAssetTypeBtn">
                  <i class="fas fa-plus"></i> Add Asset Type
                </button>
              </div>
            </div>
          </div>
          
          <!-- Asset Types List -->
          <div>
            <h6>Existing Asset Types</h6>
            <div id="assetTypesList" class="list-group" style="max-height: 200px; overflow-y: auto;">
              <!-- Asset types will be loaded here -->
            </div>
          </div>
        </div>
        
        <hr>
        
        <!-- Asset Names Management -->
        <div class="mb-4">
          <h6><i class="fas fa-box"></i> Asset Names Management</h6>
          <!-- Add New Asset Name Form -->
          <div class="mb-3">
            <div class="row">
              <div class="col-md-4">
                <select class="form-select" id="newAssetNameType" required>
                  <option value="">Select Asset Type</option>
                </select>
              </div>
              <div class="col-md-6">
                <input type="text" class="form-control" id="newAssetName" placeholder="Enter asset name" maxlength="100">
              </div>
              <div class="col-md-2">
                <button class="btn btn-success w-100" type="button" id="addAssetNameBtn">
                  <i class="fas fa-plus"></i> Add
                </button>
              </div>
            </div>
          </div>
          
          <!-- Asset Names List -->
          <div>
            <h6>Existing Asset Names</h6>
            <div class="mb-3">
              <label for="assetNameFilterType" class="form-label">Filter by Asset Type:</label>
              <select class="form-select" id="assetNameFilterType">
                <option value="">All Asset Types</option>
              </select>
            </div>
            <div id="assetNamesList" class="list-group" style="max-height: 300px; overflow-y: auto;">
              <!-- Asset names will be loaded here -->
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Bulk QR Code Printing Modal -->
<div class="modal fade" id="bulkQrModal" tabindex="-1" aria-labelledby="bulkQrModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="bulkQrModalLabel">
          <i class="fas fa-qrcode"></i> Bulk QR Code Printing
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="bulkQrHeader" class="alert alert-primary mb-3">
          <!-- Asset info will be displayed here -->
        </div>
        
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="qrSizeSelect" class="form-label">QR Code Size:</label>
            <select class="form-select" id="qrSizeSelect">
              <option value="120" selected>Large (120px)</option>
              <option value="150">Extra Large (150px)</option>
              <option value="200">Thermal Size (200px)</option>
            </select>
          </div>
          <div class="col-md-6">
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i>
              <strong>Thermal Printer Mode:</strong> 1 QR code per page
            </div>
          </div>
        </div>
        
        <div id="bulkQrContainer" class="row g-3">
          <!-- QR codes will be displayed here -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="printBulkQrBtn">
          <i class="fas fa-print"></i> Print QR Codes
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Bulk Status Update Modal -->
<div class="modal fade" id="bulkStatusModal" tabindex="-1" aria-labelledby="bulkStatusModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" style="max-width: 60%;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="bulkStatusModalLabel">
          <i class="fas fa-edit"></i> Update Asset Status
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i>
          <strong>Update Status:</strong> Change the status of <span id="bulkStatusCount">0</span> selected asset(s).
        </div>
        <div class="mb-3">
          <label for="bulkStatusSelect" class="form-label">New Status:</label>
          <select class="form-select" id="bulkStatusSelect" required>
            <option value="">Select Status</option>
            <option value="Used">Used</option>
            <option value="Not Used">Not Used</option>
            <option value="Out of Service">Out of Service</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" id="confirmBulkStatusBtn">
          <i class="fas fa-save"></i> Update Status
        </button>
      </div>
    </div>
  </div>
</div>

    <!-- Management Modals -->
    <!-- Manage Buildings Modal -->
    <div class="modal fade" id="manageBuildingsModal" tabindex="-1" aria-labelledby="manageBuildingsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="manageBuildingsModalLabel">
                        <i class="fas fa-building"></i> Manage Buildings
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center">
                        <i class="fas fa-building fa-3x text-primary mb-3"></i>
                        <h4>Building Management</h4>
                        <p class="text-muted">Add, edit, and manage building information</p>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            Building management functionality will be implemented here.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Departments Modal -->
    <div class="modal fade" id="manageDepartmentsModal" tabindex="-1" aria-labelledby="manageDepartmentsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="manageDepartmentsModalLabel">
                        <i class="fas fa-sitemap"></i> Manage Departments
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center">
                        <i class="fas fa-sitemap fa-3x text-primary mb-3"></i>
                        <h4>Department Management</h4>
                        <p class="text-muted">Organize and manage department structure</p>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            Department management functionality will be implemented here.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Employees Modal -->
    <div class="modal fade" id="manageEmployeesModal" tabindex="-1" aria-labelledby="manageEmployeesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="manageEmployeesModalLabel">
                        <i class="fas fa-user-tie"></i> Manage Employees
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center">
                        <i class="fas fa-user-tie fa-3x text-primary mb-3"></i>
                        <h4>Employee Management</h4>
                        <p class="text-muted">Manage employee information and assignments</p>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            Employee management functionality will be implemented here.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Assets Modal -->
    <div class="modal fade" id="manageAssetsModal" tabindex="-1" aria-labelledby="manageAssetsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="manageAssetsModalLabel">
                        <i class="fas fa-boxes"></i> Manage Assets
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center">
                        <i class="fas fa-boxes fa-3x text-primary mb-3"></i>
                        <h4>Asset Management</h4>
                        <p class="text-muted">Comprehensive asset management system</p>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            Asset management functionality will be implemented here.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Price Analysis Modal -->
    <div class="modal fade" id="priceAnalysisModal" tabindex="-1" aria-labelledby="priceAnalysisModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl" style="max-width: 95%; max-height: 95vh;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="priceAnalysisModalLabel">
          <i class="fas fa-coins"></i> Asset Price Analysis
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="overflow-y: auto; max-height: 80vh;">
                       <!-- System Summary -->
               <div class="row mb-4">
                 <div class="col-md-12">
                   <div class="alert alert-success">
                     <h6><i class="fas fa-info-circle"></i> System Overview</h6>
                     <p class="mb-0 system-value-text" style="font-weight: 500;">Total System Value: <strong class="system-value-text">OMR {{ "%.3f"|format(chart_data.total_system_value) }}</strong></p>
                   </div>
                 </div>
               </div>

        <!-- Building Analysis -->
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="card">
                                   <div class="card-header d-flex justify-content-between align-items-center">
                       <h6 class="mb-0"><i class="fas fa-building"></i> Total Value by Building</h6>
                       <div class="d-flex align-items-center">
                         <label class="form-label me-2 mb-0 price-analysis-filter-label">Filter by:</label>
                         <select class="form-select form-select-sm price-analysis-filter-select" style="width: auto;" onchange="filterBuildingTable(this.value)">
                           <option value="">All Buildings</option>
                           {% for building in chart_data.building_prices.keys() %}
                           <option value="{{ building }}">{{ building }}</option>
                           {% endfor %}
                         </select>
                       </div>
                     </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-striped table-sm" id="buildingTable">
                    <thead>
                      <tr>
                        <th>Building</th>
                        <th class="text-end">Total Value (OMR)</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for building, value in chart_data.building_prices.items() %}
                      <tr data-building="{{ building }}" data-value="{{ value }}">
                        <td><strong>{{ building }}</strong></td>
                        <td class="text-end"><span class="badge bg-success">{{ "%.3f"|format(value) }}</span></td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Department Analysis -->
          <div class="col-md-6">
            <div class="card">
                                   <div class="card-header d-flex justify-content-between align-items-center">
                       <h6 class="mb-0"><i class="fas fa-sitemap"></i> Total Value by Department</h6>
                       <div class="d-flex align-items-center">
                         <label class="form-label me-2 mb-0 price-analysis-filter-label">Filter by:</label>
                         <select class="form-select form-select-sm price-analysis-filter-select" style="width: auto;" onchange="filterDepartmentTable(this.value)">
                           <option value="">All Departments</option>
                           {% for dept_key in chart_data.department_prices.keys() %}
                           {% set building, department = dept_key.split('-', 1) %}
                           <option value="{{ building }}-{{ department }}">{{ building }} - {{ department }}</option>
                           {% endfor %}
                         </select>
                       </div>
                     </div>
              <div class="card-body">
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                  <table class="table table-striped table-sm">
                    <thead>
                      <tr>
                        <th>Department</th>
                        <th class="text-end">Total Value (OMR)</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for dept_key, value in chart_data.department_prices.items() %}
                      {% set building, department = dept_key.split('-', 1) %}
                      <tr>
                        <td><strong>{{ building }} - {{ department }}</strong></td>
                        <td class="text-end"><span class="badge bg-info">{{ "%.3f"|format(value) }}</span></td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Detailed Breakdown -->
        <div class="row">
          <div class="col-md-12">
            <div class="card">
                                   <div class="card-header d-flex justify-content-between align-items-center">
                       <h6 class="mb-0"><i class="fas fa-list"></i> Detailed Asset Breakdown</h6>
                       <div class="d-flex align-items-center">
                         <label class="form-label me-2 mb-0 price-analysis-filter-label">Filter by:</label>
                         <select class="form-select form-select-sm price-analysis-filter-select" style="width: auto;" onchange="filterAssetTable(this.value)">
                           <option value="">All Assets</option>
                           {% for building in chart_data.building_prices.keys() %}
                           <option value="{{ building }}">{{ building }}</option>
                           {% endfor %}
                         </select>
                       </div>
                     </div>
              <div class="card-body">
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                  <table class="table table-striped table-sm">
                    <thead>
                      <tr>
                        <th>Asset Name</th>
                        <th>Building</th>
                        <th>Department</th>
                        <th>Quantity</th>
                        <th>Unit Price (OMR)</th>
                        <th class="text-end">Total Value (OMR)</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for asset in assets %}
                      <tr>
                        <td><strong>{{ asset.name }}</strong><br><small class="text-muted">{{ asset.asset_code }}</small></td>
                        <td>{{ asset.building }}</td>
                        <td>{{ asset.department }}</td>
                        <td>{{ asset.quantity }}</td>
                        <td>{{ "%.3f"|format(asset.price or 0.0) }}</td>
                        <td class="text-end"><span class="badge bg-primary">{{ "%.3f"|format((asset.price or 0.0) * asset.quantity) }}</span></td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-success" onclick="exportPriceAnalysis()">
          <i class="fas fa-download"></i> Export Data
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
/**
 * ASSET TRACKING SYSTEM - MAIN JAVASCRIPT
 * ========================================
 * 
 * This file contains all JavaScript functionality for the Asset Tracking System.
 * The code is organized into logical sections for easy navigation and debugging:
 * 
 * 1. GLOBAL VARIABLES - Shared state across functions
 * 2. DATA LOADING - Functions to fetch and cache data
 * 3. BUILDING MANAGEMENT - CRUD operations for buildings
 * 4. DEPARTMENT MANAGEMENT - CRUD operations for departments
 * 5. USER MANAGEMENT - CRUD operations for users
 * 6. QR CODE FUNCTIONALITY - QR generation and display
 * 7. BULK SELECTION - Multi-select and bulk operations
 * 8. EVENT LISTENERS - All user interaction handlers
 * 9. UTILITY FUNCTIONS - Helper functions
 * 10. INITIALIZATION - Page load setup
 * 
 * DEBUGGING TIPS:
 * - Use browser console to inspect global variables
 * - Check network tab for API calls
 * - Use breakpoints in specific function sections
 * - Monitor selectedAssets array for bulk operations
 */

// ============================================================================
// GLOBAL VARIABLES & STATE MANAGEMENT
// ============================================================================
let buildingsData = [];
let departmentsData = [];
let selectedAssets = [];

// ============================================================================
// ADMIN MENU TOGGLE FUNCTION
// ============================================================================
function toggleAdminMenu() {
    const dropdown = document.getElementById('adminMenuDropdown');
    if (dropdown) {
        dropdown.classList.toggle('show');
    }
}

// Close menu when clicking outside
document.addEventListener('click', function(event) {
    const menuButton = document.getElementById('adminMenuButton');
    const dropdown = document.getElementById('adminMenuDropdown');
    
    if (menuButton && dropdown && !menuButton.contains(event.target)) {
        dropdown.classList.remove('show');
    }
});

// Handle submenu toggles
document.addEventListener('click', function(event) {
    const submenuTrigger = event.target.closest('.submenu-trigger');
    if (submenuTrigger) {
        event.preventDefault();
        event.stopPropagation();
        const menuItem = submenuTrigger.closest('.has-submenu');
        if (menuItem) {
            // Close other open submenus first
            const otherOpenMenus = document.querySelectorAll('.has-submenu.open');
            otherOpenMenus.forEach(openMenu => {
                if (openMenu !== menuItem) {
                    openMenu.classList.remove('open');
                }
            });
            menuItem.classList.toggle('open');
        }
    }
});

// Initialize submenu functionality when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Ensure submenu triggers are properly set up
    const submenuTriggers = document.querySelectorAll('.submenu-trigger');
    submenuTriggers.forEach(trigger => {
        trigger.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const menuItem = this.closest('.has-submenu');
            if (menuItem) {
                menuItem.classList.toggle('open');
            }
        });
    });
});





// ============================================================================
// DATA LOADING & INITIALIZATION
// ============================================================================

    /**
     * Load buildings from database and update all related UI components
     * Called on page load and after building operations
     */
    function loadBuildings() {
        fetch('/admin/buildings')
            .then(response => response.json())
            .then(data => {
                buildingsData = data;
                updateBuildingDropdown();
                updateBuildingsList();
                updateDepartmentBuildingDropdown();
            })
            .catch(error => {
                console.error('Error loading buildings:', error);
                alert('Failed to load buildings. Please refresh the page.');
            });
    }

    /**
     * Load departments from database and update all related UI components
     * Called on page load and after department operations
     */
    function loadDepartments() {
        fetch('/admin/departments')
            .then(response => response.json())
            .then(data => {
                departmentsData = data;
                updateDepartmentsList();
                updateDepartmentQRList();
                updateDepartmentFilterDropdown();
            })
            .catch(error => console.error('Error loading departments:', error));
    }

// ============================================================================
// BUILDING MANAGEMENT FUNCTIONS
// ============================================================================

    // Update building dropdown options
    function updateBuildingDropdown() {
        const buildingSelect = document.getElementById('building');
        buildingSelect.innerHTML = '<option value="">Select Building</option>';
        buildingsData.forEach(building => {
            const option = document.createElement('option');
            option.value = building.name;
            option.textContent = building.name;
            buildingSelect.appendChild(option);
        });
    }

    // Update department building dropdown in management modal
    function updateDepartmentBuildingDropdown() {
        const select = document.getElementById('newDepartmentBuilding');
        select.innerHTML = '<option value="">Select Building</option>';
        buildingsData.forEach(building => {
            const option = document.createElement('option');
            option.value = building.id;
            option.textContent = building.name;
            select.appendChild(option);
        });
    }

    // Update buildings list in management modal
    function updateBuildingsList() {
        const buildingsList = document.getElementById('buildingsList');
        buildingsList.innerHTML = '';
        
        buildingsData.forEach(building => {
            const listItem = document.createElement('div');
            listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
            listItem.innerHTML = `
                <span class="building-name" data-id="${building.id}">${building.name}</span>
                <div>
                    <button class="btn btn-sm btn-outline-primary edit-building-btn me-2" data-id="${building.id}" data-name="${building.name}">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-building-btn" data-id="${building.id}" data-name="${building.name}">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            `;
            buildingsList.appendChild(listItem);
        });

        // Add event listeners for edit and delete buttons
        document.querySelectorAll('.edit-building-btn').forEach(btn => {
            btn.addEventListener('click', handleEditBuilding);
        });
        
        document.querySelectorAll('.delete-building-btn').forEach(btn => {
            btn.addEventListener('click', handleDeleteBuilding);
        });
    }

// ============================================================================
// DEPARTMENT MANAGEMENT FUNCTIONS
// ============================================================================

    // Update departments list in management modal
    function updateDepartmentsList() {
        const departmentsList = document.getElementById('departmentsList');
        const filterSelect = document.getElementById('departmentFilterBuilding');
        const selectedBuilding = filterSelect ? filterSelect.value : '';
        
        departmentsList.innerHTML = '';
        
        // Filter departments based on selected building
        let filteredDepartments = departmentsData;
        if (selectedBuilding) {
            filteredDepartments = departmentsData.filter(dept => dept.building_name === selectedBuilding);
        }
        
        if (filteredDepartments.length === 0) {
            departmentsList.innerHTML = '<div class="text-center text-muted p-3">No departments found</div>';
            return;
        }
        
        // Group departments by building
        const departmentsByBuilding = {};
        filteredDepartments.forEach(department => {
            if (!departmentsByBuilding[department.building_name]) {
                departmentsByBuilding[department.building_name] = [];
            }
            departmentsByBuilding[department.building_name].push(department);
        });
        
        // Create organized list
        Object.keys(departmentsByBuilding).sort().forEach(buildingName => {
            if (!selectedBuilding) {
                // Only show building headers when not filtering
                const buildingHeader = document.createElement('div');
                buildingHeader.className = 'list-group-item list-group-item-info fw-bold';
                buildingHeader.innerHTML = `<i class="fas fa-building"></i> ${buildingName}`;
                departmentsList.appendChild(buildingHeader);
            }
            
            departmentsByBuilding[buildingName].forEach(department => {
                const listItem = document.createElement('div');
                listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                listItem.innerHTML = `
                    <div>
                        <span class="department-name fw-bold" data-id="${department.id}">${department.name}</span>
                        ${selectedBuilding ? '' : `<small class="text-muted d-block"><i class="fas fa-building"></i> ${department.building_name}</small>`}
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-primary edit-department-btn me-2" 
                                data-id="${department.id}" 
                                data-name="${department.name}"
                                data-building="${department.building_name}">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-department-btn" 
                                data-id="${department.id}" 
                                data-name="${department.name}"
                                data-building="${department.building_name}">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `;
                departmentsList.appendChild(listItem);
            });
        });

        // Add event listeners for edit and delete buttons
        document.querySelectorAll('.edit-department-btn').forEach(btn => {
            btn.addEventListener('click', handleEditDepartment);
        });
        
        document.querySelectorAll('.delete-department-btn').forEach(btn => {
            btn.addEventListener('click', handleDeleteDepartment);
        });
    }

    // Update department filter dropdown
    function updateDepartmentFilterDropdown() {
        const filterSelect = document.getElementById('departmentFilterBuilding');
        if (!filterSelect) return;
        
        filterSelect.innerHTML = '<option value="">All Buildings</option>';
        
        const uniqueBuildings = [...new Set(departmentsData.map(dept => dept.building_name))].sort();
        uniqueBuildings.forEach(building => {
            const option = document.createElement('option');
            option.value = building;
            option.textContent = building;
            filterSelect.appendChild(option);
        });
        
        // Add change listener
        filterSelect.addEventListener('change', function() {
            updateDepartmentsList();
        });
    }

    // Update department QR codes list
    function updateDepartmentQRList() {
        const qrList = document.getElementById('departmentQRList');
        qrList.innerHTML = '';
        
        if (departmentsData.length === 0) {
            qrList.innerHTML = '<div class="col-12 text-center text-muted">No departments found</div>';
            return;
        }
        
        departmentsData.forEach(department => {
            const colDiv = document.createElement('div');
            colDiv.className = 'col-md-6 col-lg-4 mb-4';
            colDiv.innerHTML = `
                <div class="card h-100">
                    <div class="card-body text-center">
                        <h6 class="card-title text-primary">MAA-${department.building_name.replace(/\s+/g, '').toUpperCase()}-${department.name.replace(/\s+/g, '').toUpperCase()}</h6>
                        <p class="card-text text-muted small">${department.building_name} - ${department.name}</p>
                        <div class="mb-3">
                            <img src="/assets/department_qr/${encodeURIComponent(department.building_name)}/${encodeURIComponent(department.name)}" 
                                 alt="QR Code for ${department.name}" 
                                 class="img-fluid" 
                                 style="max-width: 120px; height: auto;">
                        </div>
                        <button class="btn btn-sm btn-outline-primary view-dept-qr-btn" 
                                data-building="${department.building_name}" 
                                data-department="${department.name}">
                            <i class="fas fa-eye"></i> View Large
                        </button>
                        <button class="btn btn-sm btn-outline-success print-dept-qr-btn" 
                                data-building="${department.building_name}" 
                                data-department="${department.name}">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>
            `;
            qrList.appendChild(colDiv);
        });

        // Add event listeners for view and print buttons
        document.querySelectorAll('.view-dept-qr-btn').forEach(btn => {
            btn.addEventListener('click', handleViewDepartmentQR);
        });
        
        document.querySelectorAll('.print-dept-qr-btn').forEach(btn => {
            btn.addEventListener('click', handlePrintDepartmentQR);
        });
    }

    // Handle viewing department QR code in large size
    function handleViewDepartmentQR(e) {
        const building = e.currentTarget.getAttribute('data-building');
        const department = e.currentTarget.getAttribute('data-department');
        
        // Use the new department QR modal
        showDepartmentQRModal(building, department);
    }

    // Handle printing department QR code
    function handlePrintDepartmentQR(e) {
        const building = e.currentTarget.getAttribute('data-building');
        const department = e.currentTarget.getAttribute('data-department');
        
        const departmentCode = `MAA-${building.replace(/\s+/g, '').toUpperCase()}-${department.replace(/\s+/g, '').toUpperCase()}`;
        var printContents = `
            <img src="/assets/department_qr/${encodeURIComponent(building)}/${encodeURIComponent(department)}" 
                 alt="QR Code for ${department}" 
                 style="max-width: 200px; height: auto;">
            <div style="margin-top:12px;font-weight:bold;font-size:1.2em;text-align:center;">
                ${departmentCode}<br>
                <small style="font-size:0.8em;color:#666;">${department} - ${building}</small>
            </div>
        `;
        
        var win = window.open('', '', 'height=400,width=400');
        win.document.write('<html><head><title></title>');
        win.document.write('<style>body{background:#fff;text-align:center;margin:0;padding:20px;display:flex;flex-direction:column;justify-content:center;min-height:100vh;} img{margin:0 auto;display:block;} div{color:#222;} @media print{body{margin:0;padding:20px;} @page{margin:0;size:auto;}}</style>');
        win.document.write('</head><body>');
        win.document.write(printContents);
        win.document.write('</body></html>');
        win.document.close();
        win.focus();
        setTimeout(function(){ win.print(); win.close(); }, 500);
    }

    // Handle exporting department QR codes to PDF
    function handleExportDepartmentQRPdf() {
        if (departmentsData.length === 0) {
            alert('No department QR codes to export.');
            return;
        }

        // Create PDF content
        let pdfContent = `
            <html>
            <head>
                <title>Department QR Codes</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    .header { text-align: center; margin-bottom: 30px; }
                    .qr-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
                    .qr-item { text-align: center; padding: 15px; border: 1px solid #ddd; }
                    .qr-code { margin-bottom: 10px; }
                    .qr-label { font-weight: bold; font-size: 14px; margin-bottom: 5px; }
                    .qr-subtitle { font-size: 12px; color: #666; }
                    @media print {
                        .qr-grid { grid-template-columns: repeat(3, 1fr); }
                        .qr-item { page-break-inside: avoid; }
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>Department QR Codes</h1>
                    <p>Generated on ${new Date().toLocaleDateString()}</p>
                </div>
                <div class="qr-grid">
        `;

        // Add each department QR code
        departmentsData.forEach(dept => {
            const departmentCode = `MAA-${dept.building_name.replace(/\s+/g, '').toUpperCase()}-${dept.name.replace(/\s+/g, '').toUpperCase()}`;
            pdfContent += `
                <div class="qr-item">
                    <div class="qr-code">
                        <img src="/assets/department_qr/${encodeURIComponent(dept.building_name)}/${encodeURIComponent(dept.name)}" 
                             alt="QR Code for ${dept.name}" 
                             style="width: 120px; height: 120px;">
                    </div>
                    <div class="qr-label">${departmentCode}</div>
                    <div class="qr-subtitle">${dept.name} - ${dept.building_name}</div>
                </div>
            `;
        });

        pdfContent += `
                </div>
            </body>
            </html>
        `;

        // Create a new window for PDF generation
        const pdfWindow = window.open('', '_blank', 'width=800,height=600');
        pdfWindow.document.write(pdfContent);
        pdfWindow.document.close();
        
        // Wait for images to load, then print
        setTimeout(() => {
            pdfWindow.focus();
            pdfWindow.print();
            setTimeout(() => {
                pdfWindow.close();
            }, 1000);
        }, 1000);
    }

// ============================================================================
// EVENT LISTENERS - BUILDING MANAGEMENT
// ============================================================================

    // Handle adding new building
    document.getElementById('addBuildingBtn').addEventListener('click', function() {
        const nameInput = document.getElementById('newBuildingName');
        const name = nameInput.value.trim();
        
        if (!name) {
            alert('Please enter a building name.');
            return;
        }

        const formData = new FormData();
        formData.append('name', name);

        fetch('/admin/buildings', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                nameInput.value = '';
                loadBuildings(); // Reload the buildings list
            } else {
                alert(data.error || 'Failed to add building.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to add building.');
        });
    });

// ============================================================================
// ASSET MANAGEMENT FUNCTIONS
// ============================================================================

    /**
     * Load asset types from database and update all related UI components
     * Called on page load and after asset type operations
     */
    function loadAssetTypes() {
        fetch('/admin/asset-types')
            .then(response => response.json())
            .then(data => {
                updateAssetTypesList();
                updateAssetTypeDropdowns();
            })
            .catch(error => {
                console.error('Error loading asset types:', error);
                alert('Failed to load asset types. Please refresh the page.');
            });
    }

    /**
     * Load asset names from database and update all related UI components
     * Called on page load and after asset name operations
     */
    function loadAssetNames() {
        fetch('/admin/asset-names')
            .then(response => response.json())
            .then(data => {
                updateAssetNamesList();
                updateAssetNameFilterDropdown();
            })
            .catch(error => {
                console.error('Error loading asset names:', error);
                alert('Failed to load asset names. Please refresh the page.');
            });
    }

    // Update asset types list in management modal
    function updateAssetTypesList() {
        const assetTypesList = document.getElementById('assetTypesList');
        assetTypesList.innerHTML = '';
        
        fetch('/admin/asset-types')
            .then(response => response.json())
            .then(assetTypes => {
                if (assetTypes.length === 0) {
                    assetTypesList.innerHTML = '<div class="text-center text-muted p-3">No asset types found</div>';
                    return;
                }
                
                assetTypes.forEach(assetType => {
                    const listItem = document.createElement('div');
                    listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                    listItem.innerHTML = `
                        <span class="asset-type-name" data-id="${assetType.id}">${assetType.name}</span>
                        <div>
                            <button class="btn btn-sm btn-outline-primary edit-asset-type-btn me-2" data-id="${assetType.id}" data-name="${assetType.name}">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-asset-type-btn" data-id="${assetType.id}" data-name="${assetType.name}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    `;
                    assetTypesList.appendChild(listItem);
                });

                // Add event listeners for edit and delete buttons
                document.querySelectorAll('.edit-asset-type-btn').forEach(btn => {
                    btn.addEventListener('click', handleEditAssetType);
                });
                
                document.querySelectorAll('.delete-asset-type-btn').forEach(btn => {
                    btn.addEventListener('click', handleDeleteAssetType);
                });
            })
            .catch(error => {
                console.error('Error loading asset types:', error);
                assetTypesList.innerHTML = '<div class="text-center text-danger p-3">Error loading asset types</div>';
            });
    }

    // Update asset names list in management modal
    function updateAssetNamesList() {
        const assetNamesList = document.getElementById('assetNamesList');
        const filterSelect = document.getElementById('assetNameFilterType');
        const selectedAssetType = filterSelect ? filterSelect.value : '';
        
        assetNamesList.innerHTML = '';
        
        fetch('/admin/asset-names')
            .then(response => response.json())
            .then(assetNames => {
                // Filter asset names based on selected asset type
                let filteredAssetNames = assetNames;
                if (selectedAssetType) {
                    filteredAssetNames = assetNames.filter(assetName => assetName.asset_type_id == selectedAssetType);
                }
                
                if (filteredAssetNames.length === 0) {
                    assetNamesList.innerHTML = '<div class="text-center text-muted p-3">No asset names found</div>';
                    return;
                }
                
                // Group asset names by asset type
                const assetNamesByType = {};
                filteredAssetNames.forEach(assetName => {
                    if (!assetNamesByType[assetName.asset_type_name]) {
                        assetNamesByType[assetName.asset_type_name] = [];
                    }
                    assetNamesByType[assetName.asset_type_name].push(assetName);
                });
                
                // Create organized list
                Object.keys(assetNamesByType).sort().forEach(assetTypeName => {
                    if (!selectedAssetType) {
                        // Only show asset type headers when not filtering
                        const assetTypeHeader = document.createElement('div');
                        assetTypeHeader.className = 'list-group-item list-group-item-info fw-bold';
                        assetTypeHeader.innerHTML = `<i class="fas fa-tag"></i> ${assetTypeName}`;
                        assetNamesList.appendChild(assetTypeHeader);
                    }
                    
                    assetNamesByType[assetTypeName].forEach(assetName => {
                        const listItem = document.createElement('div');
                        listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                        listItem.innerHTML = `
                            <div>
                                <span class="asset-name-name fw-bold" data-id="${assetName.id}">${assetName.name}</span>
                                ${selectedAssetType ? '' : `<small class="text-muted d-block"><i class="fas fa-tag"></i> ${assetName.asset_type_name}</small>`}
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-primary edit-asset-name-btn me-2" 
                                        data-id="${assetName.id}" 
                                        data-name="${assetName.name}"
                                        data-asset-type="${assetName.asset_type_name}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-asset-name-btn" 
                                        data-id="${assetName.id}" 
                                        data-name="${assetName.name}"
                                        data-asset-type="${assetName.asset_type_name}">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        `;
                        assetNamesList.appendChild(listItem);
                    });
                });

                // Add event listeners for edit and delete buttons
                document.querySelectorAll('.edit-asset-name-btn').forEach(btn => {
                    btn.addEventListener('click', handleEditAssetName);
                });
                
                document.querySelectorAll('.delete-asset-name-btn').forEach(btn => {
                    btn.addEventListener('click', handleDeleteAssetName);
                });
            })
            .catch(error => {
                console.error('Error loading asset names:', error);
                assetNamesList.innerHTML = '<div class="text-center text-danger p-3">Error loading asset names</div>';
            });
    }

    // Update asset type dropdowns
    function updateAssetTypeDropdowns() {
        fetch('/admin/asset-types')
            .then(response => response.json())
            .then(assetTypes => {
                // Update new asset name type dropdown
                const newAssetNameTypeSelect = document.getElementById('newAssetNameType');
                if (newAssetNameTypeSelect) {
                    newAssetNameTypeSelect.innerHTML = '<option value="">Select Asset Type</option>';
                    assetTypes.forEach(assetType => {
                        const option = document.createElement('option');
                        option.value = assetType.id;
                        option.textContent = assetType.name;
                        newAssetNameTypeSelect.appendChild(option);
                    });
                }
                
                // Update asset name filter dropdown
                const assetNameFilterSelect = document.getElementById('assetNameFilterType');
                if (assetNameFilterSelect) {
                    assetNameFilterSelect.innerHTML = '<option value="">All Asset Types</option>';
                    assetTypes.forEach(assetType => {
                        const option = document.createElement('option');
                        option.value = assetType.id;
                        option.textContent = assetType.name;
                        assetNameFilterSelect.appendChild(option);
                    });
                }
                
                // Update add asset modal asset type dropdown
                const addAssetTypeSelect = document.getElementById('asset_type');
                if (addAssetTypeSelect) {
                    addAssetTypeSelect.innerHTML = '<option value="">Select Asset Type</option>';
                    assetTypes.forEach(assetType => {
                        const option = document.createElement('option');
                        option.value = assetType.name;
                        option.textContent = assetType.name;
                        addAssetTypeSelect.appendChild(option);
                    });
                }
                
                // Update edit asset modal asset type dropdown
                const editAssetTypeSelect = document.getElementById('edit_asset_type');
                if (editAssetTypeSelect) {
                    editAssetTypeSelect.innerHTML = '<option value="">Select Asset Type</option>';
                    assetTypes.forEach(assetType => {
                        const option = document.createElement('option');
                        option.value = assetType.name;
                        option.textContent = assetType.name;
                        editAssetTypeSelect.appendChild(option);
                    });
                }
                
                // Update main page asset type filter dropdown
                const assetTypeFilterSelect = document.getElementById('assetTypeFilter');
                if (assetTypeFilterSelect) {
                    assetTypeFilterSelect.innerHTML = '<option value="">All Types</option>';
                    assetTypes.forEach(assetType => {
                        const option = document.createElement('option');
                        option.value = assetType.name;
                        option.textContent = assetType.name;
                        // Check if this option should be selected based on current filter
                        if (new URLSearchParams(window.location.search).get('asset_type') === assetType.name) {
                            option.selected = true;
                        }
                        assetTypeFilterSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading asset types for dropdowns:', error);
            });
    }

    // Update asset name filter dropdown
    function updateAssetNameFilterDropdown() {
        const filterSelect = document.getElementById('assetNameFilterType');
        if (!filterSelect) return;
        
        // Add change listener
        filterSelect.addEventListener('change', function() {
            updateAssetNamesList();
        });
    }

    // Update asset name dropdowns for add/edit asset forms
    function updateAssetNameDropdowns() {
        fetch('/admin/asset-names')
            .then(response => response.json())
            .then(assetNames => {
                // Group asset names by asset type
                const assetNamesByType = {};
                assetNames.forEach(assetName => {
                    if (!assetNamesByType[assetName.asset_type_name]) {
                        assetNamesByType[assetName.asset_type_name] = [];
                    }
                    assetNamesByType[assetName.asset_type_name].push(assetName);
                });
                
                // Store the grouped data for use in change handlers
                window.assetNamesByType = assetNamesByType;
            })
            .catch(error => {
                console.error('Error loading asset names for dropdowns:', error);
            });
    }

    // Update asset name datalist based on selected asset type
    function updateAssetNameDropdown(assetTypeName, inputId) {
        const input = document.getElementById(inputId);
        const datalistId = inputId === 'name' ? 'assetNameList' : 'editAssetNameList';
        const datalist = document.getElementById(datalistId);
        
        if (!input || !datalist) return;
        
        // Clear existing options
        datalist.innerHTML = '';
        
        if (!assetTypeName || !window.assetNamesByType || !window.assetNamesByType[assetTypeName]) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'No asset names available for this type';
            datalist.appendChild(option);
            return;
        }
        
        // Add all asset names for the selected type
        window.assetNamesByType[assetTypeName].forEach(assetName => {
            const option = document.createElement('option');
            option.value = assetName.name;
            option.textContent = assetName.name;
            datalist.appendChild(option);
        });
        
        // Set initial placeholder
        const totalOptions = window.assetNamesByType[assetTypeName].length;
        input.placeholder = `Type to search predefined names (${totalOptions} available)`;
        
        // Add event listener for real-time filtering
        input.addEventListener('input', function() {
            filterAssetNameOptions(assetTypeName, inputId);
        });
        
        // Add event listener for selection (only for add asset form)
        if (inputId === 'name') {
            input.addEventListener('change', function() {
                const selectedValue = this.value.trim();
                if (selectedValue && validateAssetName(assetTypeName, selectedValue)) {
                    addAssetNameToSelection(selectedValue);
                    this.value = '';
                }
            });
        }
    }

    // Filter asset name options based on user input
    function filterAssetNameOptions(assetTypeName, inputId) {
        const input = document.getElementById(inputId);
        const datalistId = inputId === 'name' ? 'assetNameList' : 'editAssetNameList';
        const datalist = document.getElementById(datalistId);
        
        if (!input || !datalist || !window.assetNamesByType || !window.assetNamesByType[assetTypeName]) {
            return;
        }
        
        const userInput = input.value.toLowerCase().trim();
        
        // Clear existing options
        datalist.innerHTML = '';
        
        if (!userInput) {
            // If no input, show all asset names for the type
            window.assetNamesByType[assetTypeName].forEach(assetName => {
                const option = document.createElement('option');
                option.value = assetName.name;
                option.textContent = assetName.name;
                datalist.appendChild(option);
            });
            return;
        }
        
        // Filter asset names that start with the user input
        const filteredNames = window.assetNamesByType[assetTypeName].filter(assetName => 
            assetName.name.toLowerCase().startsWith(userInput)
        );
        
        // Add filtered options
        filteredNames.forEach(assetName => {
            const option = document.createElement('option');
            option.value = assetName.name;
            option.textContent = assetName.name;
            datalist.appendChild(option);
        });
        
        // If no matches found, show a message
        if (filteredNames.length === 0) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'No matching asset names found';
            datalist.appendChild(option);
        }
        
        // Update placeholder to show available options
        const totalOptions = window.assetNamesByType[assetTypeName].length;
        const availableOptions = filteredNames.length;
        if (userInput) {
            input.placeholder = `Found ${availableOptions} of ${totalOptions} asset names (type to filter)`;
        } else {
            input.placeholder = `Type to search predefined names (${totalOptions} available)`;
        }
    }

    // Validate asset name exists in predefined list
    function validateAssetName(assetTypeName, assetName) {
        if (!assetTypeName || !assetName || !window.assetNamesByType || !window.assetNamesByType[assetTypeName]) {
            return false;
        }
        
        const validNames = window.assetNamesByType[assetTypeName].map(item => item.name);
        return validNames.includes(assetName);
    }

    // Multi-select asset names functionality
    let selectedAssetNames = [];

    // Add asset name to selected list
    function addAssetNameToSelection(assetName) {
        if (!selectedAssetNames.includes(assetName)) {
            selectedAssetNames.push(assetName);
            updateSelectedAssetNamesDisplay();
            updateHiddenInput();
        }
    }

    // Remove asset name from selected list
    function removeAssetNameFromSelection(assetName) {
        const index = selectedAssetNames.indexOf(assetName);
        if (index > -1) {
            selectedAssetNames.splice(index, 1);
            updateSelectedAssetNamesDisplay();
            updateHiddenInput();
        }
    }

    // Update the display of selected asset names
    function updateSelectedAssetNamesDisplay() {
        const container = document.getElementById('selectedAssetNames');
        if (!container) return;
        
        container.innerHTML = '';
        
        selectedAssetNames.forEach(assetName => {
            const tag = document.createElement('div');
            tag.className = 'asset-name-tag';
            tag.innerHTML = `
                <span class="asset-name-text">${assetName}</span>
                <button type="button" class="remove-btn" onclick="removeAssetNameFromSelection('${assetName}')">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(tag);
        });
    }

    // Update hidden input with selected asset names
    function updateHiddenInput() {
        const hiddenInput = document.getElementById('selectedAssetNamesInput');
        if (hiddenInput) {
            hiddenInput.value = selectedAssetNames.join(',');
        }
    }

    // Clear selected asset names
    function clearSelectedAssetNames() {
        selectedAssetNames = [];
        updateSelectedAssetNamesDisplay();
        updateHiddenInput();
    }



// ============================================================================
// EVENT LISTENERS - DEPARTMENT MANAGEMENT
// ============================================================================

    // Handle adding new department
    document.getElementById('addDepartmentBtn').addEventListener('click', function() {
        const nameInput = document.getElementById('newDepartmentName');
        const buildingSelect = document.getElementById('newDepartmentBuilding');
        const name = nameInput.value.trim();
        const buildingId = buildingSelect.value;
        
        if (!name) {
            alert('Please enter a department name.');
            return;
        }

        if (!buildingId) {
            alert('Please select a building.');
            return;
        }

        const formData = new FormData();
        formData.append('name', name);
        formData.append('building_id', buildingId);

        fetch('/admin/departments', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                nameInput.value = '';
                buildingSelect.value = '';
                loadDepartments(); // Reload the departments list
                updateDepartmentQRList(); // Refresh the QR list
            } else {
                alert(data.error || 'Failed to add department.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to add department.');
        });
    });



// ============================================================================
// EVENT LISTENERS - USER MANAGEMENT
// ============================================================================

    // USER MODAL EVENT LISTENERS
    document.getElementById('addUserModalBtn').addEventListener('click', handleAddUserModal);
    document.getElementById('addBulkUsersModalBtn').addEventListener('click', handleAddBulkUsersModal);
    
    document.getElementById('userModalBuilding').addEventListener('change', function() {
        updateUserModalDepartments(this.value);
    });
    
    document.getElementById('bulkUserModalBuilding').addEventListener('change', function() {
        updateBulkUserModalDepartments(this.value);
    });
    
    document.getElementById('userModalFilterDepartment').addEventListener('change', function() {
        loadUserModalUsers(this.value);
    });
    
    document.getElementById('userModalName').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            handleAddUserModal();
        }
    });

// ============================================================================
// EVENT LISTENERS - DYNAMIC DROPDOWNS
// ============================================================================

    // Handle department change to update owner dropdown
    document.getElementById('department').addEventListener('change', function() {
        loadOwnersForDepartment(this.value);
        checkNoOwnerOption();
    });

    // Handle no owner checkbox
    document.getElementById('noOwnerCheck').addEventListener('change', function() {
        const ownerSelect = document.getElementById('owner');
        const noOwnerCheck = document.getElementById('noOwnerCheck');
        
        if (noOwnerCheck.checked) {
            ownerSelect.disabled = true;
            ownerSelect.value = '';
            ownerSelect.style.opacity = '0.6';
            ownerSelect.style.backgroundColor = '#f8f9fa';
            ownerSelect.removeAttribute('required');
        } else {
            ownerSelect.disabled = false;
            ownerSelect.style.opacity = '1';
            ownerSelect.style.backgroundColor = '';
            ownerSelect.setAttribute('required', 'required');
            // Reload owners for current department
            loadOwnersForDepartment(document.getElementById('department').value);
        }
    });

    // Function to check if department should have no owner option
    function checkNoOwnerOption() {
        const departmentSelect = document.getElementById('department');
        const noOwnerCheck = document.getElementById('noOwnerCheck');
        const ownerSelect = document.getElementById('owner');
        
        const selectedDepartment = departmentSelect.value;
        
        if (selectedDepartment) {
            // Show the checkbox and enable it for all departments
            noOwnerCheck.parentElement.style.display = 'block';
            noOwnerCheck.disabled = false;
            
            // If checkbox is checked, keep owner disabled
            if (noOwnerCheck.checked) {
                ownerSelect.disabled = true;
                ownerSelect.style.opacity = '0.6';
                ownerSelect.style.backgroundColor = '#f8f9fa';
            }
        } else {
            // Hide the checkbox when no department is selected
            noOwnerCheck.parentElement.style.display = 'none';
            noOwnerCheck.checked = false;
            ownerSelect.disabled = false;
            ownerSelect.style.opacity = '1';
            ownerSelect.style.backgroundColor = '';
        }
    }

    /**
     * Dynamically load owners for a selected department
     * Updates the owner dropdown based on department selection
     * @param {string} departmentName - The selected department name
     */
    function loadOwnersForDepartment(departmentName) {
        const ownerSelect = document.getElementById('owner');
        
        // Clear existing options
        ownerSelect.innerHTML = '<option value="">Loading...</option>';
        
        if (!departmentName) {
            ownerSelect.innerHTML = '<option value="">Select Department First</option>';
            return;
        }
        
        // Find department ID by name
        fetch('/admin/departments')
            .then(response => response.json())
            .then(departments => {
                const department = departments.find(d => d.name === departmentName);
                if (!department) {
                    ownerSelect.innerHTML = '<option value="">Department not found</option>';
                    return;
                }
                
                // Fetch users for this department
                return fetch(`/admin/users?department_id=${department.id}`);
            })
            .then(response => response.json())
            .then(users => {
                ownerSelect.innerHTML = '<option value="">Select Owner</option>';
                
                if (users.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No users in this department';
                    option.disabled = true;
                    ownerSelect.appendChild(option);
                } else {
                    users.sort((a, b) => a.name.localeCompare(b.name)).forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.name;
                        option.textContent = user.name;
                        ownerSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading owners:', error);
                ownerSelect.innerHTML = '<option value="">Error loading owners</option>';
            });
    }

    // Handle editing building
    function handleEditBuilding(e) {
        const buildingId = e.currentTarget.getAttribute('data-id');
        const currentName = e.currentTarget.getAttribute('data-name');
        const newName = prompt('Enter new building name:', currentName);
        
        if (newName && newName.trim() !== currentName) {
            const formData = new FormData();
            formData.append('name', newName.trim());

            fetch(`/admin/buildings/${buildingId}`, {
                method: 'PUT',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadBuildings(); // Reload the buildings list
                    loadDepartments(); // Reload departments list to update building names
                } else {
                    alert(data.error || 'Failed to update building.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update building.');
            });
        }
    }

    // Handle editing department
    function handleEditDepartment(e) {
        const departmentId = e.currentTarget.getAttribute('data-id');
        const currentName = e.currentTarget.getAttribute('data-name');
        const buildingName = e.currentTarget.getAttribute('data-building');
        
        const newName = prompt(`Edit department name for "${buildingName}":\n\nCurrent name: ${currentName}\nEnter new name:`, currentName);
        
        if (newName && newName.trim() !== currentName) {
            const formData = new FormData();
            formData.append('name', newName.trim());

            fetch(`/admin/departments/${departmentId}`, {
                method: 'PUT',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadDepartments(); // Reload the departments list
                } else {
                    alert(data.error || 'Failed to update department.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update department.');
            });
        }
    }

    // Handle deleting building
    function handleDeleteBuilding(e) {
        const buildingId = e.currentTarget.getAttribute('data-id');
        const buildingName = e.currentTarget.getAttribute('data-name');
        
        if (confirm(`Are you sure you want to delete "${buildingName}"? This will also delete all its departments.`)) {
            fetch(`/admin/buildings/${buildingId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadBuildings(); // Reload the buildings list
                    loadDepartments(); // Reload departments list
                } else {
                    alert(data.error || 'Failed to delete building.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to delete building.');
            });
        }
    }

    // Handle deleting department
    function handleDeleteDepartment(e) {
        const departmentId = e.currentTarget.getAttribute('data-id');
        const departmentName = e.currentTarget.getAttribute('data-name');
        const buildingName = e.currentTarget.getAttribute('data-building');
        
        if (confirm(`Are you sure you want to delete "${departmentName}" from "${buildingName}"?`)) {
            fetch(`/admin/departments/${departmentId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadDepartments(); // Reload the departments list
                } else {
                    alert(data.error || 'Failed to delete department.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to delete department.');
            });
        }
    }

// ============================================================================
// EVENT LISTENERS - ASSET MANAGEMENT
// ============================================================================

    // Handle adding new asset type
    document.getElementById('addAssetTypeBtn').addEventListener('click', function() {
        const nameInput = document.getElementById('newAssetTypeName');
        const name = nameInput.value.trim();
        
        if (!name) {
            alert('Please enter an asset type name.');
            return;
        }

        const formData = new FormData();
        formData.append('name', name);

        fetch('/admin/asset-types', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
                    .then(data => {
                if (data.success) {
                    nameInput.value = '';
                    loadAssetTypes(); // Reload the asset types list
                    loadAssetNames(); // Reload asset names to update dropdowns
                    updateAssetNameDropdowns(); // Update dropdown data
                } else {
                    alert(data.error || 'Failed to add asset type.');
                }
            })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to add asset type.');
        });
    });

    // Handle adding new asset name
    document.getElementById('addAssetNameBtn').addEventListener('click', function() {
        const nameInput = document.getElementById('newAssetName');
        const typeSelect = document.getElementById('newAssetNameType');
        const name = nameInput.value.trim();
        const assetTypeId = typeSelect.value;
        
        if (!name) {
            alert('Please enter an asset name.');
            return;
        }

        if (!assetTypeId) {
            alert('Please select an asset type.');
            return;
        }

        const formData = new FormData();
        formData.append('name', name);
        formData.append('asset_type_id', assetTypeId);

        fetch('/admin/asset-names', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
                    .then(data => {
                if (data.success) {
                    nameInput.value = '';
                    typeSelect.value = '';
                    loadAssetNames(); // Reload the asset names list
                    updateAssetNameDropdowns(); // Update dropdown data
                } else {
                    alert(data.error || 'Failed to add asset name.');
                }
            })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to add asset name.');
        });
    });

    // Handle editing asset type
    function handleEditAssetType(e) {
        const assetTypeId = e.currentTarget.getAttribute('data-id');
        const currentName = e.currentTarget.getAttribute('data-name');
        
        const newName = prompt('Enter new asset type name:', currentName);
        
        if (newName && newName.trim() !== currentName) {
            const formData = new FormData();
            formData.append('name', newName.trim());

            fetch(`/admin/asset-types/${assetTypeId}`, {
                method: 'PUT',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadAssetTypes(); // Reload the asset types list
                    loadAssetNames(); // Reload asset names to update dropdowns
                    updateAssetNameDropdowns(); // Update dropdown data
                } else {
                    alert(data.error || 'Failed to update asset type.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update asset type.');
            });
        }
    }

    // Handle editing asset name
    function handleEditAssetName(e) {
        const assetNameId = e.currentTarget.getAttribute('data-id');
        const currentName = e.currentTarget.getAttribute('data-name');
        const assetTypeName = e.currentTarget.getAttribute('data-asset-type');
        
        const newName = prompt(`Edit asset name for "${assetTypeName}":\n\nCurrent name: ${currentName}\nEnter new name:`, currentName);
        
        if (newName && newName.trim() !== currentName) {
            const formData = new FormData();
            formData.append('name', newName.trim());

            fetch(`/admin/asset-names/${assetNameId}`, {
                method: 'PUT',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadAssetNames(); // Reload the asset names list
                    updateAssetNameDropdowns(); // Update dropdown data
                } else {
                    alert(data.error || 'Failed to update asset name.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update asset name.');
            });
        }
    }

    // Handle deleting asset type
    function handleDeleteAssetType(e) {
        const assetTypeId = e.currentTarget.getAttribute('data-id');
        const assetTypeName = e.currentTarget.getAttribute('data-name');
        
        if (confirm(`Are you sure you want to delete "${assetTypeName}"? This will also delete all its asset names.`)) {
            fetch(`/admin/asset-types/${assetTypeId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadAssetTypes(); // Reload the asset types list
                    loadAssetNames(); // Reload asset names list
                    updateAssetNameDropdowns(); // Update dropdown data
                } else {
                    alert(data.error || 'Failed to delete asset type.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to delete asset type.');
            });
        }
    }

    // Handle deleting asset name
    function handleDeleteAssetName(e) {
        const assetNameId = e.currentTarget.getAttribute('data-id');
        const assetName = e.currentTarget.getAttribute('data-name');
        const assetTypeName = e.currentTarget.getAttribute('data-asset-type');
        
        if (confirm(`Are you sure you want to delete "${assetName}" from "${assetTypeName}"?`)) {
            fetch(`/admin/asset-names/${assetNameId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadAssetNames(); // Reload the asset names list
                    updateAssetNameDropdowns(); // Update dropdown data
                } else {
                    alert(data.error || 'Failed to delete asset name.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to delete asset name.');
            });
        }
    }

    // ===== USER MODAL FUNCTIONS =====

    // Load data for user modal
    function loadUserModalData() {
        loadUserModalBuildings();
        loadBulkUserModalBuildings();
        loadUserModalUsers();
        loadUserModalFilterDropdown();
    }

    // Load buildings for user modal
    function loadUserModalBuildings() {
        fetch('/admin/buildings')
            .then(response => response.json())
            .then(buildings => {
                const buildingSelect = document.getElementById('userModalBuilding');
                buildingSelect.innerHTML = '<option value="">Select Building</option>';
                
                buildings.forEach(building => {
                    const option = document.createElement('option');
                    option.value = building.id;
                    option.textContent = building.name;
                    buildingSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading buildings for user modal:', error);
            });
    }

    // Load buildings for bulk user modal
    function loadBulkUserModalBuildings() {
        fetch('/admin/buildings')
            .then(response => response.json())
            .then(buildings => {
                const buildingSelect = document.getElementById('bulkUserModalBuilding');
                buildingSelect.innerHTML = '<option value="">Select Building</option>';
                
                buildings.forEach(building => {
                    const option = document.createElement('option');
                    option.value = building.id;
                    option.textContent = building.name;
                    buildingSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading buildings for bulk user modal:', error);
            });
    }

    // Update departments in user modal based on building
    function updateUserModalDepartments(buildingId) {
        const departmentSelect = document.getElementById('userModalDepartment');
        
        if (!buildingId) {
            departmentSelect.innerHTML = '<option value="">Select Building First</option>';
            return;
        }
        
        departmentSelect.innerHTML = '<option value="">Loading...</option>';
        
        fetch(`/admin/departments?building_id=${buildingId}`)
            .then(response => response.json())
            .then(departments => {
                departmentSelect.innerHTML = '<option value="">Select Department</option>';
                
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.id;
                    option.textContent = dept.name;
                    departmentSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading departments for user modal:', error);
                departmentSelect.innerHTML = '<option value="">Error loading departments</option>';
            });
    }

    // Load users for user modal
    function loadUserModalUsers(filterDepartmentId = '') {
        const url = filterDepartmentId ? `/admin/users?department_id=${filterDepartmentId}` : '/admin/users';
        
        fetch(url)
            .then(response => response.json())
            .then(users => {
                const usersList = document.getElementById('userModalList');
                usersList.innerHTML = '';
                
                if (users.length === 0) {
                    usersList.innerHTML = '<div class="list-group-item text-muted">No users found.</div>';
                    return;
                }
                
                // Group users by building and department
                const usersByGroup = {};
                users.forEach(user => {
                    const key = `${user.building_name} - ${user.department_name}`;
                    if (!usersByGroup[key]) {
                        usersByGroup[key] = [];
                    }
                    usersByGroup[key].push(user);
                });
                
                // Display users grouped by department
                Object.keys(usersByGroup).sort().forEach(groupKey => {
                    // Add group header
                    const groupHeader = document.createElement('div');
                    groupHeader.className = 'list-group-item list-group-item-light fw-bold';
                    groupHeader.innerHTML = `<i class="fas fa-building"></i> ${groupKey}`;
                    usersList.appendChild(groupHeader);
                    
                    // Add users in this group
                    usersByGroup[groupKey].sort((a, b) => a.name.localeCompare(b.name)).forEach(user => {
                        const userItem = document.createElement('div');
                        userItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                        userItem.innerHTML = `
                            <span><i class="fas fa-user"></i> ${user.name}</span>
                            <div>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="handleEditUserModal(event)" 
                                        data-id="${user.id}" data-name="${user.name}" data-department="${user.department_name}" 
                                        title="Edit User">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="handleDeleteUserModal(event)" 
                                        data-id="${user.id}" data-name="${user.name}" data-department="${user.department_name}" 
                                        title="Delete User">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        usersList.appendChild(userItem);
                    });
                });
            })
            .catch(error => {
                console.error('Error loading users for modal:', error);
            });
    }

    // Load filter dropdown for user modal
    function loadUserModalFilterDropdown() {
        fetch('/admin/departments')
            .then(response => response.json())
            .then(departments => {
                const filterSelect = document.getElementById('userModalFilterDepartment');
                filterSelect.innerHTML = '<option value="">All Departments</option>';
                
                // Group departments by building
                const departmentsByBuilding = {};
                departments.forEach(dept => {
                    if (!departmentsByBuilding[dept.building_name]) {
                        departmentsByBuilding[dept.building_name] = [];
                    }
                    departmentsByBuilding[dept.building_name].push(dept);
                });
                
                // Add options grouped by building
                Object.keys(departmentsByBuilding).sort().forEach(buildingName => {
                    const group = document.createElement('optgroup');
                    group.label = buildingName;
                    
                    departmentsByBuilding[buildingName].sort((a, b) => a.name.localeCompare(b.name)).forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept.id;
                        option.textContent = dept.name;
                        group.appendChild(option);
                    });
                    
                    filterSelect.appendChild(group);
                });
            })
            .catch(error => {
                console.error('Error loading departments for filter:', error);
            });
    }

    // Handle adding user from modal
    function handleAddUserModal() {
        const buildingId = document.getElementById('userModalBuilding').value;
        const departmentId = document.getElementById('userModalDepartment').value;
        const name = document.getElementById('userModalName').value.trim();
        
        if (!buildingId) {
            alert('Please select a building.');
            return;
        }
        
        if (!departmentId) {
            alert('Please select a department.');
            return;
        }
        
        if (!name) {
            alert('Please enter a user name.');
            return;
        }
        
        fetch('/admin/users', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: name,
                department_id: parseInt(departmentId)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.id) {
                document.getElementById('userModalName').value = '';
                document.getElementById('userModalBuilding').value = '';
                document.getElementById('userModalDepartment').value = '';
                document.getElementById('userModalDepartment').innerHTML = '<option value="">Select Building First</option>';
                loadUserModalUsers(); // Reload the users list
                loadOwnersForDepartment(document.getElementById('department').value); // Refresh owner dropdown
                alert(`✅ User "${name}" registered successfully!`);
            } else {
                alert(data.error || 'Failed to register user.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to register user.');
        });
    }

    // Handle editing user from modal
    function handleEditUserModal(e) {
        const userId = e.currentTarget.getAttribute('data-id');
        const currentName = e.currentTarget.getAttribute('data-name');
        const departmentName = e.currentTarget.getAttribute('data-department');
        
        const newName = prompt(`Edit user name for "${departmentName}" department:`, currentName);
        if (newName && newName.trim() && newName.trim() !== currentName) {
            fetch(`/admin/users/${userId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: newName.trim()
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadUserModalUsers(); // Reload the users list
                    loadOwnersForDepartment(document.getElementById('department').value); // Refresh owner dropdown
                } else {
                    alert(data.error || 'Failed to update user.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update user.');
            });
        }
    }

    // Handle deleting user from modal
    function handleDeleteUserModal(e) {
        const userId = e.currentTarget.getAttribute('data-id');
        const userName = e.currentTarget.getAttribute('data-name');
        const departmentName = e.currentTarget.getAttribute('data-department');
        
        if (confirm(`Are you sure you want to delete "${userName}" from "${departmentName}"?`)) {
            fetch(`/admin/users/${userId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadUserModalUsers(); // Reload the users list
                    loadOwnersForDepartment(document.getElementById('department').value); // Refresh owner dropdown
                } else {
                    alert(data.error || 'Failed to delete user.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to delete user.');
            });
        }
    }

    // Handle bulk adding users from modal
    function handleAddBulkUsersModal() {
        const buildingId = document.getElementById('bulkUserModalBuilding').value;
        const departmentId = document.getElementById('bulkUserModalDepartment').value;
        const userNamesText = document.getElementById('bulkUserNames').value.trim();
        
        if (!buildingId) {
            alert('Please select a building.');
            return;
        }
        
        if (!departmentId) {
            alert('Please select a department.');
            return;
        }
        
        if (!userNamesText) {
            alert('Please enter user names.');
            return;
        }
        
        // Split the text into individual names and filter out empty lines
        const userNames = userNamesText.split('\n')
            .map(name => name.trim())
            .filter(name => name.length > 0);
        
        if (userNames.length === 0) {
            alert('Please enter at least one valid user name.');
            return;
        }
        
        // Show confirmation with count
        if (!confirm(`Add ${userNames.length} user(s) to the selected department?\n\nUsers to add:\n${userNames.join('\n')}`)) {
            return;
        }
        
        fetch('/admin/users/bulk', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                users: userNames,
                department_id: parseInt(departmentId)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.added_users) {
                // Clear the form
                document.getElementById('bulkUserNames').value = '';
                document.getElementById('bulkUserModalBuilding').value = '';
                document.getElementById('bulkUserModalDepartment').value = '';
                document.getElementById('bulkUserModalDepartment').innerHTML = '<option value="">Select Building First</option>';
                
                // Reload data
                loadUserModalUsers();
                loadOwnersForDepartment(document.getElementById('department').value);
                
                // Show results
                let message = `✅ Successfully added ${data.total_added} user(s)!`;
                if (data.total_errors > 0) {
                    message += `\n\n❌ ${data.total_errors} user(s) could not be added:\n${data.errors.join('\n')}`;
                }
                alert(message);
            } else {
                alert(data.error || 'Failed to add users.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to add users.');
        });
    }

    // Update bulk user modal departments when building changes
    function updateBulkUserModalDepartments(buildingId) {
        const departmentSelect = document.getElementById('bulkUserModalDepartment');
        departmentSelect.innerHTML = '<option value="">Loading...</option>';
        
        if (!buildingId) {
            departmentSelect.innerHTML = '<option value="">Select Building First</option>';
            return;
        }
        
        fetch(`/admin/departments?building_id=${buildingId}`)
            .then(response => response.json())
            .then(departments => {
                departmentSelect.innerHTML = '<option value="">Select Department</option>';
                departments.forEach(department => {
                    const option = document.createElement('option');
                    option.value = department.id;
                    option.textContent = department.name;
                    departmentSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading departments:', error);
                departmentSelect.innerHTML = '<option value="">Error loading departments</option>';
            });
    }

// ============================================================================
// INITIALIZATION
// ============================================================================

    // Initialize data on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadBuildings();
        loadDepartments();
        loadUserModalData();
            loadAssetTypes();
            loadAssetNames();
            updateAssetNameDropdowns();
            
            // Add event listeners for asset type changes
            document.getElementById('asset_type').addEventListener('change', function() {
                updateAssetNameDropdown(this.value, 'name');
            });
            
            document.getElementById('edit_asset_type').addEventListener('change', function() {
                updateAssetNameDropdown(this.value, 'edit_name');
            });
            
            // Add form validation for add asset form
            document.getElementById('addAssetForm').addEventListener('submit', function(e) {
                const assetType = document.getElementById('asset_type').value;
                const selectedAssetNamesInput = document.getElementById('selectedAssetNamesInput');
                
                if (!assetType) {
                    e.preventDefault();
                    alert('Please select an asset type.');
                    return;
                }
                
                if (!selectedAssetNamesInput || !selectedAssetNamesInput.value.trim()) {
                    e.preventDefault();
                    alert('Please select at least one asset name.');
                    return;
                }
                
                // Validate that all selected asset names exist in the predefined list
                const selectedNames = selectedAssetNamesInput.value.split(',').filter(name => name.trim());
                for (const assetName of selectedNames) {
                    if (!validateAssetName(assetType, assetName.trim())) {
                        e.preventDefault();
                        alert(`Asset name "${assetName.trim()}" does not exist. Please select from the available asset names or add it first through the "Manage Assets" button.`);
                        return;
                    }
                }
            });
            

        
        // Refresh user modal data when modal is shown
        document.getElementById('userManagementModal').addEventListener('show.bs.modal', function() {
            loadUserModalData();
        });
        
        // Refresh building management data when modal is shown
        document.getElementById('buildingManagementModal').addEventListener('show.bs.modal', function() {
            loadBuildings();
        });
        
        // Refresh department management data when modal is shown
        document.getElementById('departmentManagementModal').addEventListener('show.bs.modal', function() {
            loadDepartments();
        });
        
        // Refresh asset management data when modal is shown
        document.getElementById('assetManagementModal').addEventListener('show.bs.modal', function() {
            loadAssetTypes();
            loadAssetNames();
            updateAssetNameDropdowns();
        });
        
        // Initialize add asset modal
        document.getElementById('addAssetModal').addEventListener('show.bs.modal', function() {
            // Reset the no owner checkbox
            const noOwnerCheck = document.getElementById('noOwnerCheck');
            noOwnerCheck.checked = false;
            noOwnerCheck.parentElement.style.display = 'none';
            
            // Reset owner dropdown
            const ownerSelect = document.getElementById('owner');
            ownerSelect.disabled = false;
            ownerSelect.style.opacity = '1';
            ownerSelect.style.backgroundColor = '';
            ownerSelect.innerHTML = '<option value="">Select Department First</option>';
            
            // Load asset types and asset names for the dropdowns
            loadAssetTypes();
            loadAssetNames();
            updateAssetNameDropdowns();
            
            // Clear selected asset names
            clearSelectedAssetNames();
        });
        
        // Initialize edit asset modal
        document.getElementById('editAssetModal').addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const assetId = button.getAttribute('data-asset-id');
            const assetName = button.getAttribute('data-asset-name');
            const assetType = button.getAttribute('data-asset-type');
            const assetQuantity = button.getAttribute('data-asset-quantity');
            const assetPrice = button.getAttribute('data-asset-price');
            const assetOwner = button.getAttribute('data-asset-owner');
            const assetBuilding = button.getAttribute('data-asset-building');
            const assetDepartment = button.getAttribute('data-asset-department');
            const assetStatus = button.getAttribute('data-asset-status');
            
            console.log('Edit modal data:', {
                assetId, assetName, assetType, assetQuantity, 
                assetOwner, assetBuilding, assetDepartment, assetStatus
            });
            
            // Update modal title and form action
            document.getElementById('editAssetName').textContent = assetName;
            document.getElementById('editAssetForm').action = `/assets/update/${assetId}`;
            
            // Populate form fields
            document.getElementById('edit_quantity').value = assetQuantity;
            document.getElementById('edit_price').value = assetPrice;
            document.getElementById('edit_used_status').value = assetStatus;
            
            // Handle old asset type values that might not match new options
            let assetTypeToSet = assetType;
            if (assetType === 'Technical Device') {
                assetTypeToSet = 'Electronics';
            } else if (assetType === 'Office Supplies') {
                assetTypeToSet = 'Others';
            }
            
            // Handle no owner case
            const editNoOwnerCheck = document.getElementById('edit_noOwnerCheck');
            const editOwnerSelect = document.getElementById('edit_owner');
            
            if (assetOwner === 'No Owner') {
                editNoOwnerCheck.checked = true;
                editOwnerSelect.disabled = true;
                editOwnerSelect.style.opacity = '0.5';
                editOwnerSelect.style.backgroundColor = '#f8f9fa';
            } else {
                editNoOwnerCheck.checked = false;
                editOwnerSelect.disabled = false;
                editOwnerSelect.style.opacity = '1';
                editOwnerSelect.style.backgroundColor = '';
            }
            
            // Load asset types and asset names for the dropdowns, then set the asset type
            loadAssetTypes();
            loadAssetNames();
            updateAssetNameDropdowns();
            
            // Set asset type after dropdowns are loaded
            setTimeout(() => {
                console.log('Setting asset type to:', assetTypeToSet);
                console.log('Available asset type options:', Array.from(document.getElementById('edit_asset_type').options).map(opt => opt.value));
                
                document.getElementById('edit_asset_type').value = assetTypeToSet;
                console.log('Asset type dropdown value after setting:', document.getElementById('edit_asset_type').value);
                console.log('Asset type dropdown selected option:', document.getElementById('edit_asset_type').selectedOptions[0]?.text);
                
                // Set asset name after asset type is set
                updateAssetNameDropdown(assetTypeToSet, 'edit_name');
                setTimeout(() => {
                    document.getElementById('edit_name').value = assetName;
                }, 100);
            }, 300);
            
            // Load buildings and populate building dropdown, then chain the other loads
            loadEditBuildings(assetBuilding).then(() => {
                // After buildings are loaded, load departments
                return loadEditDepartments(assetBuilding, assetDepartment);
            }).then(() => {
                // After departments are loaded, load owners
                return loadEditOwners(assetBuilding, assetDepartment, assetOwner);
            }).catch(error => {
                console.error('Error loading edit data:', error);
            });
        });
        
        // Handle edit no owner checkbox
        document.getElementById('edit_noOwnerCheck').addEventListener('change', function() {
            const editOwnerSelect = document.getElementById('edit_owner');
            if (this.checked) {
                editOwnerSelect.disabled = true;
                editOwnerSelect.style.opacity = '0.5';
                editOwnerSelect.style.backgroundColor = '#f8f9fa';
                editOwnerSelect.value = '';
            } else {
                editOwnerSelect.disabled = false;
                editOwnerSelect.style.opacity = '1';
                editOwnerSelect.style.backgroundColor = '';
            }
        });
        
        // Handle edit building change
        document.getElementById('edit_building').addEventListener('change', function() {
            const selectedBuilding = this.value;
            const departmentSelect = document.getElementById('edit_department');
            const ownerSelect = document.getElementById('edit_owner');
            
            departmentSelect.innerHTML = '<option value="">Select Department/Section</option>';
            ownerSelect.innerHTML = '<option value="">Select Department First</option>';
            
            if (selectedBuilding) {
                // Find the building ID by fetching buildings data
                fetch('/admin/buildings')
                    .then(response => response.json())
                    .then(buildings => {
                        const building = buildings.find(b => b.name === selectedBuilding);
                        if (building) {
                            // Load departments for this building
                            return fetch(`/admin/departments?building_id=${building.id}`);
                        }
                        return Promise.reject('Building not found');
                    })
                    .then(response => response.json())
                    .then(departments => {
                        departments.forEach(department => {
                            const option = document.createElement('option');
                            option.value = department.name;
                            option.textContent = department.name;
                            departmentSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error loading departments:', error));
            }
        });
        
        // Handle edit department change
        document.getElementById('edit_department').addEventListener('change', function() {
            const selectedDepartment = this.value;
            const selectedBuilding = document.getElementById('edit_building').value;
            const ownerSelect = document.getElementById('edit_owner');
            
            ownerSelect.innerHTML = '<option value="">Select Owner</option>';
            
            if (selectedDepartment && selectedBuilding) {
                // Find department ID by fetching departments data
                fetch('/admin/departments')
                    .then(response => response.json())
                    .then(departments => {
                        const department = departments.find(d => 
                            d.building_name === selectedBuilding && d.name === selectedDepartment
                        );
                        
                        if (department) {
                            // Load users for this department
                            return fetch(`/admin/users?department_id=${department.id}`);
                        }
                        return Promise.reject('Department not found');
                    })
                    .then(response => response.json())
                    .then(users => {
                        users.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.name;
                            option.textContent = user.name;
                            ownerSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error loading users:', error));
            }
        });
        
        // Handle edit form submission
        document.getElementById('editAssetForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Form validation
            const assetType = document.getElementById('edit_asset_type').value;
            const assetName = document.getElementById('edit_name').value.trim();
            
            if (!assetType) {
                alert('Please select an asset type.');
                return;
            }
            
            if (!assetName) {
                alert('Please enter an asset name.');
                return;
            }
            
            // Validate that the asset name exists in the predefined list
            if (!validateAssetName(assetType, assetName)) {
                alert(`Asset name "${assetName}" does not exist. Please select from the available asset names or add it first through the "Manage Assets" button.`);
                return;
            }
            
            // Show confirmation dialog
            if (!confirm(`Are you sure you want to update the asset "${assetName}"?`)) {
                return; // User cancelled
            }
            
            const formData = new FormData(this);
            
            fetch(this.action, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Check if asset code changed
                    if (data.asset_code_changed) {
                        const message = `Asset updated successfully!\n\nAsset code has been updated:\nOld: ${data.old_asset_code}\nNew: ${data.new_asset_code}\n\nThis change was made because the building or department was modified.`;
                        alert(message);
                    } else {
                        alert('Asset updated successfully!');
                    }
                    
                    // Close modal and refresh page
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editAssetModal'));
                    modal.hide();
                    window.location.reload();
                } else {
                    alert('Error updating asset: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating asset. Please try again.');
            });
        });
        
        // Initialize department QR PDF export
        document.getElementById('exportDepartmentQRPdfBtn').addEventListener('click', handleExportDepartmentQRPdf);
    });

    // Handle Enter key in new building input
    document.getElementById('newBuildingName').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('addBuildingBtn').click();
        }
    });

    // Handle Enter key in new department input
    document.getElementById('newDepartmentName').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('addDepartmentBtn').click();
        }
    });

    document.getElementById('building').addEventListener('change', function() {
        const selectedBuilding = this.value;
        const departmentSelect = document.getElementById('department');
        departmentSelect.innerHTML = '<option value="">Select Department/Section</option>';
        
        if (selectedBuilding) {
            // Find the building ID
            const building = buildingsData.find(b => b.name === selectedBuilding);
            if (building) {
                // Load departments for this building
                fetch(`/admin/departments?building_id=${building.id}`)
                    .then(response => response.json())
                    .then(departments => {
                        departments.forEach(department => {
                            const option = document.createElement('option');
                            option.value = department.name;
                            option.textContent = department.name;
                            departmentSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error loading departments:', error));
            }
        }
    });

// ============================================================================
// EVENT LISTENERS - QR CODE FUNCTIONALITY
// ============================================================================

    // QR Modal logic for image-based QR codes
    function showQRModal(assetId, assetCode, assetName) {
        const modalImage = document.getElementById('qrModalImage');
        const modalAssetName = document.getElementById('qrModalAssetName');
        const modalAssetCode = document.getElementById('qrModalAssetCode');
        
        // Set larger QR code image using our own endpoint with golden colors
        modalImage.src = `/assets/qrcode/${assetId}`;
        modalAssetName.textContent = assetName;
        modalAssetCode.textContent = assetCode;
        
        // Show the modal
        const qrModal = new bootstrap.Modal(document.getElementById('qrModal'));
        qrModal.show();
    }

    // Department QR Modal logic
    function showDepartmentQRModal(building, department) {
        const modalImage = document.getElementById('individualDepartmentQRImage');
        const modalName = document.getElementById('individualDepartmentQRName');
        const modalCode = document.getElementById('individualDepartmentQRCode');
        
        // Set department QR code image
        modalImage.src = `/assets/department_qr/${encodeURIComponent(building)}/${encodeURIComponent(department)}`;
        modalName.textContent = `${department} - ${building}`;
        modalCode.textContent = `MAA-${building.replace(/\s+/g, '').toUpperCase()}-${department.replace(/\s+/g, '').toUpperCase()}`;
        
        // Show the modal
        const departmentQRModal = new bootstrap.Modal(document.getElementById('individualDepartmentQRModal'));
        departmentQRModal.show();
    }

    // Legacy QR Modal logic (keeping for compatibility)
    document.querySelectorAll('.view-qr-link').forEach(function(link) {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const assetId = this.getAttribute('data-asset-id');
            fetch(`/assets/qrdata/${assetId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('qrcode').innerHTML = '';
                        document.getElementById('qrCodeLabel').innerHTML = '<div class="text-danger">QR data not found.</div>';
                    } else {
                        document.getElementById('qrcode').innerHTML = '';
                        // Build URL for QR
                        const qrString = window.location.origin + '/asset/' + data.asset_code;
                        new QRCode(document.getElementById('qrcode'), {
                            text: qrString,
                            width: 200,
                            height: 200,
                                                                            colorDark: "#d1b173",
                            colorLight: "#181818"
                        });
                        document.getElementById('qrCodeLabel').innerText = data.asset_code;
                    }
                    var qrModal = new bootstrap.Modal(document.getElementById('qrModal'));
                    qrModal.show();
                });
        });
    });



    // Print QR code button logic
    document.getElementById('printQrBtn').onclick = function() {
        const modalImage = document.getElementById('qrModalImage');
        const modalAssetName = document.getElementById('qrModalAssetName');
        const modalAssetCode = document.getElementById('qrModalAssetCode');
        const qrcodeDiv = document.getElementById('qrcode');
        const qrCodeLabel = document.getElementById('qrCodeLabel');
        
        let printContents = '';
        
        // Check if we're using image-based QR code or JavaScript-generated
        if (modalImage.src && modalImage.src !== window.location.href) {
            // Image-based QR code
            printContents = `
                <img src="${modalImage.src}" alt="QR Code" style="width: 120px; height: 120px; object-fit: contain; margin: 0 auto; display: block; border: 2px solid #d1b173; border-radius: 4px;">
                <div style="margin-top:10px;font-weight:bold;font-size:1em;text-align:center;">
                    ${modalAssetName.textContent}<br>
                    <small style="font-size:0.8em;color:#666;">${modalAssetCode.textContent}</small>
                </div>
            `;
        } else {
            // Legacy JavaScript-generated QR code
            printContents = qrcodeDiv.innerHTML + '<div style="margin-top:12px;font-weight:bold;font-size:1.2em;text-align:center;">' + qrCodeLabel.innerText + '</div>';
        }
        
        var win = window.open('', '', 'height=400,width=400');
        win.document.write('<html><head><title></title>');
        win.document.write('<style>body{background:#fff;text-align:center;margin:0;padding:20px;display:flex;flex-direction:column;justify-content:center;min-height:100vh;} img{margin:0 auto;display:block;} div{color:#222;} @media print{body{margin:0;padding:20px;} @page{margin:0;size:auto;}}</style>');
        win.document.write('</head><body>');
        win.document.write(printContents);
        win.document.write('</body></html>');
        win.document.close();
        win.focus();
        setTimeout(function(){ win.print(); win.close(); }, 500);
    };

    // Print individual department QR code button logic
    document.getElementById('printIndividualDepartmentQRBtn').onclick = function() {
        const modalImage = document.getElementById('individualDepartmentQRImage');
        const modalName = document.getElementById('individualDepartmentQRName');
        const modalCode = document.getElementById('individualDepartmentQRCode');
        
        const printContents = `
            <img src="${modalImage.src}" alt="Department QR Code" style="max-width: 200px; height: auto; margin: 0 auto; display: block;">
            <div style="margin-top:12px;font-weight:bold;font-size:1.2em;text-align:center;">
                ${modalName.textContent}<br>
                <small style="font-size:0.8em;color:#666;">${modalCode.textContent}</small>
            </div>
        `;
        
        var win = window.open('', '', 'height=400,width=400');
        win.document.write('<html><head><title></title>');
        win.document.write('<style>body{background:#fff;text-align:center;margin:0;padding:20px;display:flex;flex-direction:column;justify-content:center;min-height:100vh;} img{margin:0 auto;display:block;} div{color:#222;} @media print{body{margin:0;padding:20px;} @page{margin:0;size:auto;}}</style>');
        win.document.write('</head><body>');
        win.document.write(printContents);
        win.document.write('</body></html>');
        win.document.close();
        win.focus();
        setTimeout(function(){ win.print(); win.close(); }, 500);
    };

// ============================================================================
// EVENT LISTENERS - STATUS UPDATES
// ============================================================================

    // Status change functionality
    document.querySelectorAll('.status-select').forEach(function(select) {
        select.addEventListener('change', function(e) {
            const assetId = this.getAttribute('data-asset-id');
            const newStatus = this.value;
            
            const formData = new FormData();
            formData.append('used_status', newStatus);
            
            fetch(`/assets/update_status/${assetId}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert('Failed to update status.');
                    // Revert the select value
                    location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update status.');
                location.reload();
            });
        });
    });

// ============================================================================
// BULK SELECTION & ACTIONS
// ============================================================================

    // Bulk selection functionality
    
    function updateBulkActionsBar() {
        const bulkBar = document.getElementById('bulkActionsBar');
        const selectedCount = document.getElementById('selectedCount');
        
        if (selectedAssets.length > 0) {
            bulkBar.style.display = 'block';
            selectedCount.textContent = selectedAssets.length;
        } else {
            bulkBar.style.display = 'none';
        }
    }

// ============================================================================
// EVENT LISTENERS - BULK SELECTION
// ============================================================================

    // Select all checkbox functionality
    document.getElementById('selectAllCheckbox').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.asset-checkbox');
        const isChecked = this.checked;
        
        selectedAssets = [];
        checkboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
            if (isChecked) {
                selectedAssets.push({
                    id: checkbox.getAttribute('data-asset-id'),
                    name: checkbox.getAttribute('data-asset-name')
                });
            }
        });
        
        updateBulkActionsBar();
    });

    // Individual checkbox functionality
    document.querySelectorAll('.asset-checkbox').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            const assetId = this.getAttribute('data-asset-id');
            const assetName = this.getAttribute('data-asset-name');
            
            if (this.checked) {
                selectedAssets.push({ id: assetId, name: assetName });
            } else {
                selectedAssets = selectedAssets.filter(asset => asset.id !== assetId);
                document.getElementById('selectAllCheckbox').checked = false;
            }
            
            updateBulkActionsBar();
        });
    });

// ============================================================================
// EVENT LISTENERS - BULK ACTIONS
// ============================================================================



    // Clear selection
    document.getElementById('clearSelectionBtn').addEventListener('click', function() {
        selectedAssets = [];
        document.querySelectorAll('.asset-checkbox').forEach(cb => cb.checked = false);
        document.getElementById('selectAllCheckbox').checked = false;
        updateBulkActionsBar();
    });

    // Bulk update status
    document.getElementById('bulkUpdateStatusBtn').addEventListener('click', function() {
        if (selectedAssets.length === 0) {
            alert('Please select at least one asset to update status.');
            return;
        }
        
        // Update the count in the modal
        document.getElementById('bulkStatusCount').textContent = selectedAssets.length;
        
        // Reset the status select
        document.getElementById('bulkStatusSelect').value = '';
        
        // Show the bulk status modal
        const bulkStatusModal = new bootstrap.Modal(document.getElementById('bulkStatusModal'));
        bulkStatusModal.show();
    });

    // Confirm bulk status update
    document.getElementById('confirmBulkStatusBtn').addEventListener('click', function() {
        const newStatus = document.getElementById('bulkStatusSelect').value;
        
        if (!newStatus) {
            alert('Please select a status.');
            return;
        }
        
        if (confirm(`Update ${selectedAssets.length} asset(s) to status "${newStatus}"?`)) {
            const formData = new FormData();
            selectedAssets.forEach(asset => formData.append('asset_ids[]', asset.id));
            formData.append('used_status', newStatus);
            
            fetch('/assets/bulk_update_status', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close the modal
                    const bulkStatusModal = bootstrap.Modal.getInstance(document.getElementById('bulkStatusModal'));
                    bulkStatusModal.hide();
                    
                    // Reload the page
                    location.reload();
                } else {
                    alert('Failed to update assets.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update assets.');
            });
        }
    });

    // Bulk delete
    document.getElementById('bulkDeleteBtn').addEventListener('click', function() {
        if (selectedAssets.length === 0) return;
        
        const assetNames = selectedAssets.map(asset => asset.name).join(', ');
        const archiveReason = prompt(`Are you sure you want to archive ${selectedAssets.length} items?\n\n${assetNames.substring(0, 200)}${assetNames.length > 200 ? '...' : ''}\n\nPlease provide a reason for archiving (optional):`);
        
        if (archiveReason !== null) { // User didn't cancel
            const formData = new FormData();
            selectedAssets.forEach(asset => formData.append('asset_ids[]', asset.id));
            formData.append('archive_reason', archiveReason || 'Assets bulk archived by user');
            
            fetch('/assets/bulk_delete', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message || `Successfully archived ${selectedAssets.length} assets!`);
                    location.reload();
                } else {
                    alert('Failed to archive assets: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to archive assets. Please check the console for details.');
            });
        }
    });

    // Bulk QR code printing
    document.getElementById('bulkPrintQrBtn').addEventListener('click', function() {
        if (selectedAssets.length === 0) {
            alert('Please select at least one asset to print QR codes.');
            return;
        }
        
        // Show the bulk QR modal
        const bulkQrModal = new bootstrap.Modal(document.getElementById('bulkQrModal'));
        bulkQrModal.show();
        
        // Display QR codes for selected assets
        displayBulkQrCodes();
    });

    // QR size change handler
    document.getElementById('qrSizeSelect').addEventListener('change', function() {
        displayBulkQrCodes();
    });



    // Print button handler
    document.getElementById('printBulkQrBtn').addEventListener('click', function() {
        // Create a new window for printing with proper styling
        const printWindow = window.open('', '_blank', 'width=800,height=600');
        
        // Get the QR codes content
        const qrContainer = document.getElementById('bulkQrContainer');
        const header = document.getElementById('bulkQrHeader');
        
        // Create print content with proper CSS
        const printContent = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>Bulk QR Codes</title>
                <style>
                    @page {
                        margin: 0;
                        size: auto;
                    }
                    
                    body {
                        margin: 0;
                        padding: 0;
                        font-family: Arial, sans-serif;
                        background: white;
                    }
                    
                    .thermal-page {
                        page-break-after: always;
                        page-break-inside: avoid;
                        margin: 0;
                        padding: 0;
                        width: 100%;
                        height: 100vh;
                        min-height: 100vh;
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        align-items: center;
                        background: white;
                        border: none;
                        position: relative;
                        overflow: hidden;
                        box-sizing: border-box;
                    }
                    
                    .thermal-page:last-child {
                        page-break-after: avoid;
                    }
                    
                    .qr-code-container {
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        align-items: center;
                        height: 100%;
                        width: 100%;
                        max-width: 400px;
                        text-align: center;
                        margin: 0;
                        padding: 20px;
                        box-sizing: border-box;
                    }
                    
                    .qr-code-img {
                        display: block;
                        margin: 0 auto 20px auto;
                        border: 2px solid #d1b173;
                        border-radius: 4px;
                        max-width: 100%;
                        height: auto;
                    }
                    
                    .fw-bold {
                        font-weight: bold;
                        color: #333;
                        font-size: 18px;
                        margin-bottom: 8px;
                    }
                    
                    .text-muted {
                        color: #666;
                        font-size: 16px;
                    }
                    
                    /* Hide any unwanted elements */
                    .modal-header, .modal-footer, .alert, .btn {
                        display: none !important;
                    }
                </style>
            </head>
            <body>
                ${qrContainer.innerHTML}
            </body>
            </html>
        `;
        
        printWindow.document.write(printContent);
        printWindow.document.close();
        
        // Wait for content to load, then print
        printWindow.onload = function() {
            setTimeout(() => {
                printWindow.focus();
                printWindow.print();
                setTimeout(() => {
                    printWindow.close();
                }, 1000);
            }, 500);
        };
    });

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

    /**
     * Display bulk QR codes for selected assets
     * Creates individual pages for thermal printer (1 QR code per page)
     */
    function displayBulkQrCodes() {
        const container = document.getElementById('bulkQrContainer');
        const header = document.getElementById('bulkQrHeader');
        const qrSize = parseInt(document.getElementById('qrSizeSelect').value);
        
        // Clear existing QR codes
        container.innerHTML = '';
        
        if (selectedAssets.length === 0) {
            container.innerHTML = '<div class="col-12 text-center text-muted">No assets selected</div>';
            header.innerHTML = '';
            return;
        }
        
        // Update header
        header.innerHTML = `
            <i class="fas fa-qrcode"></i> <strong>Thermal Printer QR Codes</strong>
            <br><small class="text-muted">${selectedAssets.length} asset(s) selected - 1 QR code per page for thermal printer</small>
        `;
        
        // Fetch full asset details to get asset codes
        fetch('/assets/assets')
            .then(response => response.json())
            .then(allAssets => {
                const selectedAssetDetails = allAssets.filter(asset => 
                    selectedAssets.some(selected => selected.id == asset.id)
                );
                
                // Create individual pages for each QR code
                selectedAssetDetails.forEach((asset, index) => {
                    // Create page container
                    const pageDiv = document.createElement('div');
                    pageDiv.className = 'thermal-page';
                    pageDiv.style.cssText = `
                        page-break-after: always; 
                        page-break-inside: avoid;
                        margin: 0; 
                        padding: 0; 
                        width: 100%; 
                        height: 100vh; 
                        min-height: 100vh;
                        display: flex; 
                        flex-direction: column; 
                        justify-content: center; 
                        align-items: center;
                        background: white;
                        border: none;
                        position: relative;
                        overflow: hidden;
                    `;
                    
                    // QR code container - centered on page
                    const qrContainer = document.createElement('div');
                    qrContainer.className = 'qr-code-container text-center';
                    qrContainer.style.cssText = `
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        align-items: center;
                        height: 100%;
                        width: 100%;
                        max-width: 400px;
                        text-align: center;
                        margin: 0;
                        padding: 20px;
                        box-sizing: border-box;
                    `;
                    
                    // QR code image
                    const qrImage = document.createElement('img');
                    qrImage.src = `/assets/qrcode/${asset.id}`;
                    qrImage.alt = `QR Code for ${asset.name}`;
                    qrImage.className = 'qr-code-img';
                    qrImage.style.cssText = `
                        width: ${qrSize}px; 
                        height: ${qrSize}px; 
                        border: 2px solid #d1b173; 
                        border-radius: 4px; 
                        margin-bottom: 20px;
                        display: block;
                        margin-left: auto;
                        margin-right: auto;
                        max-width: 100%;
                        height: auto;
                    `;
                    
                    // Asset info
                    const assetInfo = document.createElement('div');
                    assetInfo.className = 'text-center';
                    assetInfo.style.cssText = `
                        text-align: center;
                        margin-top: 10px;
                    `;
                    assetInfo.innerHTML = `
                        <div class="fw-bold" style="font-size: 18px; margin-bottom: 8px; color: #333;">${asset.asset_code}</div>
                        <div class="text-muted" style="font-size: 16px; color: #666;">${asset.name}</div>
                    `;
                    
                    qrContainer.appendChild(qrImage);
                    qrContainer.appendChild(assetInfo);
                    pageDiv.appendChild(qrContainer);
                    container.appendChild(pageDiv);
                });
            })
            .catch(error => {
                console.error('Error fetching asset details:', error);
                container.innerHTML = '<div class="col-12 text-center text-danger">Error loading asset information</div>';
            });
    }

    /**
     * Debug helper - Log current state to console
     * Useful for troubleshooting data issues
     */
    function debugState() {
        console.log('=== DEBUG STATE ===');
        console.log('Buildings:', buildingsData);
        console.log('Departments:', departmentsData);
        console.log('Selected Assets:', selectedAssets);
        console.log('==================');
    }

    // Jump to page functionality
    function jumpToPage() {
        const pageInput = document.getElementById('jumpToPage');
        const pageNumber = parseInt(pageInput.value);
        const maxPages = parseInt(pageInput.getAttribute('max'));
        
        if (pageNumber >= 1 && pageNumber <= maxPages) {
            const currentUrl = new URL(window.location);
            currentUrl.searchParams.set('page', pageNumber);
            window.location.href = currentUrl.toString();
        } else {
            alert(`Please enter a page number between 1 and ${maxPages}`);
            pageInput.value = parseInt('{{ page }}');
        }
    }

// ============================================================================
// EVENT LISTENERS - SEARCH & NAVIGATION
// ============================================================================

    // Global search functionality
    document.getElementById('globalSearch').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('searchForm').submit();
        }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + F for search
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
            e.preventDefault();
            document.getElementById('globalSearch').focus();
        }
        
        // Ctrl/Cmd + A for select all
        if ((e.ctrlKey || e.metaKey) && e.key === 'a' && !e.target.matches('input, textarea')) {
            e.preventDefault();
            document.getElementById('selectAllCheckbox').click();
        }
        
        // Escape to clear selection
        if (e.key === 'Escape') {
            if (selectedAssets.length > 0) {
                document.getElementById('clearSelectionBtn').click();
            }
        }
        
        // Ctrl/Cmd + D for debug state
        if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
            e.preventDefault();
            debugState();
        }
    });



// ============================================================================
// DARK MODE FUNCTIONALITY
// ============================================================================

    // Dark mode toggle functionality - Simplified and more robust
    function initializeDarkMode() {
        const darkModeToggle = document.getElementById('darkModeToggle');
        const body = document.body;
        
        if (!darkModeToggle) {
            console.error('Dark mode toggle button not found!');
            return;
        }
        
        console.log('Dark mode toggle button found:', darkModeToggle);
        
        // Check for saved dark mode preference
        const darkMode = localStorage.getItem('darkMode') === 'true';
        
        // Apply dark mode if previously enabled
        if (darkMode) {
            body.classList.add('dark-mode');
            updateDarkModeButton(true);
        }
        
        // Toggle dark mode with direct click handler
        darkModeToggle.onclick = function(e) {
            e.preventDefault();
            console.log('Dark mode toggle clicked!');
            
            body.classList.toggle('dark-mode');
            const isDarkMode = body.classList.contains('dark-mode');
            
            // Save preference to localStorage
            localStorage.setItem('darkMode', isDarkMode);
            
            // Update button appearance
            updateDarkModeButton(isDarkMode);
            
            console.log('Dark mode toggled:', isDarkMode);
        };
        
        function updateDarkModeButton(isDarkMode) {
            const icon = darkModeToggle.querySelector('i');
            const text = darkModeToggle.querySelector('span');
            
            if (isDarkMode) {
                icon.className = 'fas fa-sun';
                text.textContent = ' Light Mode';
                darkModeToggle.style.borderColor = '#ffd700';
                darkModeToggle.style.color = '#ffd700';
            } else {
                icon.className = 'fas fa-moon';
                text.textContent = ' Dark Mode';
                darkModeToggle.style.borderColor = '#6c757d';
                darkModeToggle.style.color = '#6c757d';
            }
        }
    }
    
    // Initialize dark mode when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeDarkMode);
    } else {
        initializeDarkMode();
    }
    
    // Additional debug: Check if button exists after a short delay
    setTimeout(function() {
        const btn = document.getElementById('darkModeToggle');
        console.log('Dark mode button check after delay:', btn);
        if (btn) {
            console.log('Button is clickable:', btn.onclick);
        }
    }, 1000);
    
    // Global function for inline onclick
    function toggleDarkMode() {
        console.log('Global toggleDarkMode called!');
        const body = document.body;
        const darkModeToggle = document.getElementById('darkModeToggle');
        
        body.classList.toggle('dark-mode');
        const isDarkMode = body.classList.contains('dark-mode');
        
        // Save preference to localStorage
        localStorage.setItem('darkMode', isDarkMode);
        
        // Update button appearance
        if (darkModeToggle) {
            const icon = darkModeToggle.querySelector('i');
            const text = darkModeToggle.querySelector('span');
            
            if (isDarkMode) {
                icon.className = 'fas fa-sun';
                text.textContent = ' Light Mode';
                darkModeToggle.style.borderColor = '#ffd700';
                darkModeToggle.style.color = '#ffd700';
            } else {
                icon.className = 'fas fa-moon';
                text.textContent = ' Dark Mode';
                darkModeToggle.style.borderColor = '#6c757d';
                darkModeToggle.style.color = '#6c757d';
            }
        }
        
        console.log('Dark mode toggled via global function:', isDarkMode);
    }
    
    // Clear filters function
    function clearFilters() {
        console.log('Clearing filters...');
        
        // Clear the search input
        document.getElementById('globalSearch').value = '';
        
        // Reset all select dropdowns to their first option (usually "All")
        const selects = [
            'buildingFilter',
            'departmentFilter', 
            'statusFilter',
            'assetTypeFilter',
            'itemsPerPage'
        ];
        
        selects.forEach(selectId => {
            const select = document.getElementById(selectId);
            if (select) {
                select.selectedIndex = 0;
            }
        });
        
        // Submit the form to refresh the page with cleared filters
                document.getElementById('searchForm').submit();
            }
    
    // AJAX filter function - updates results without page refresh
    function applyFilters() {
        console.log('Applying filters via AJAX...');
        
        const formData = new FormData(document.getElementById('searchForm'));
        const params = new URLSearchParams();
        
        // Add all form data to URL parameters
        for (let [key, value] of formData.entries()) {
            if (value) {
                params.append(key, value);
            }
        }
        
        // Update URL without page refresh
        const newUrl = window.location.pathname + '?' + params.toString();
        window.history.pushState({}, '', newUrl);
        
        // Show loading indicator
        const tableBody = document.querySelector('.table tbody');
        if (tableBody) {
            tableBody.innerHTML = '<tr><td colspan="9" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';
        }
        
        // Fetch updated results
        fetch(newUrl)
            .then(response => response.text())
            .then(html => {
                // Create a temporary div to parse the HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Extract the table body content
                const newTableBody = tempDiv.querySelector('.table tbody');
                const newPagination = tempDiv.querySelector('.pagination');
                const newStats = tempDiv.querySelectorAll('.card-body h5');
                
                // Update the table body
                if (newTableBody && tableBody) {
                    tableBody.innerHTML = newTableBody.innerHTML;
                }
                
                // Update pagination
                const currentPagination = document.querySelector('.pagination');
                if (newPagination && currentPagination) {
                    currentPagination.innerHTML = newPagination.innerHTML;
                }
                
                // Update stats cards
                newStats.forEach((stat, index) => {
                    const currentStat = document.querySelectorAll('.card-body h5')[index];
                    if (currentStat && stat) {
                        currentStat.textContent = stat.textContent;
                    }
                });
                
                console.log('Filters applied successfully');
            })
            .catch(error => {
                console.error('Error applying filters:', error);
                // Fallback to page refresh if AJAX fails
                window.location.reload();
            });
    }
    
    // Add event listeners to all filter dropdowns
    document.addEventListener('DOMContentLoaded', function() {
        const filterSelects = [
            'buildingFilter',
            'departmentFilter',
            'statusFilter',
            'assetTypeFilter',
            'itemsPerPage'
        ];
        
        filterSelects.forEach(selectId => {
            const select = document.getElementById(selectId);
            if (select) {
                select.addEventListener('change', function() {
                    console.log(`${selectId} changed to:`, this.value);
                    applyFilters();
                });
            }
        });
    });
    
    // Helper functions for edit modal
    function loadEditBuildings(selectedBuilding) {
        console.log('Loading buildings for edit, selected:', selectedBuilding);
        return fetch('/admin/buildings')
            .then(response => response.json())
            .then(buildings => {
                const buildingSelect = document.getElementById('edit_building');
                buildingSelect.innerHTML = '<option value="">Select Building</option>';
                
                buildings.forEach(building => {
                    const option = document.createElement('option');
                    option.value = building.name;
                    option.textContent = building.name;
                    buildingSelect.appendChild(option);
                });
                
                // Set the selected building after populating options
                if (selectedBuilding) {
                    buildingSelect.value = selectedBuilding;
                    console.log('Set building to:', selectedBuilding);
                }
            })
            .catch(error => {
                console.error('Error loading buildings for edit:', error);
                throw error;
            });
    }
    
    function loadEditDepartments(selectedBuilding, selectedDepartment) {
        console.log('Loading departments for edit, building:', selectedBuilding, 'department:', selectedDepartment);
        if (!selectedBuilding) return Promise.resolve();
        
        // Find the building ID by fetching buildings data
        return fetch('/admin/buildings')
            .then(response => response.json())
            .then(buildings => {
                const building = buildings.find(b => b.name === selectedBuilding);
                if (building) {
                    return fetch(`/admin/departments?building_id=${building.id}`);
                }
                return Promise.reject('Building not found');
            })
            .then(response => response.json())
            .then(departments => {
                const departmentSelect = document.getElementById('edit_department');
                departmentSelect.innerHTML = '<option value="">Select Department/Section</option>';
                
                departments.forEach(department => {
                    const option = document.createElement('option');
                    option.value = department.name;
                    option.textContent = department.name;
                    departmentSelect.appendChild(option);
                });
                
                // Set the selected department after populating options
                if (selectedDepartment) {
                    departmentSelect.value = selectedDepartment;
                    console.log('Set department to:', selectedDepartment);
                }
            })
            .catch(error => {
                console.error('Error loading departments for edit:', error);
                throw error;
            });
    }
    
    function loadEditOwners(selectedBuilding, selectedDepartment, selectedOwner) {
        console.log('Loading owners for edit, building:', selectedBuilding, 'department:', selectedDepartment, 'owner:', selectedOwner);
        if (!selectedBuilding || !selectedDepartment) return Promise.resolve();
        
        // Find department ID
        return fetch('/admin/departments')
            .then(response => response.json())
            .then(departments => {
                const department = departments.find(d => 
                    d.building_name === selectedBuilding && d.name === selectedDepartment
                );
                
                if (department) {
                    return fetch(`/admin/users?department_id=${department.id}`);
                }
                return Promise.reject('Department not found');
            })
            .then(response => response.json())
            .then(users => {
                const ownerSelect = document.getElementById('edit_owner');
                ownerSelect.innerHTML = '<option value="">Select Owner</option>';
                
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.name;
                    option.textContent = user.name;
                    ownerSelect.appendChild(option);
                });
                
                // Set the selected owner after populating options
                if (selectedOwner && selectedOwner !== 'No Owner') {
                    ownerSelect.value = selectedOwner;
                    console.log('Set owner to:', selectedOwner);
                }
            })
            .catch(error => {
                console.error('Error loading users for edit:', error);
                throw error;
            });
    }

    // --- Improved Asset Name Multi-Select ---
    const assetNameInput = document.getElementById('name');
    const assetNameDropdown = document.getElementById('assetNameDropdown');
    const assetNameList = document.getElementById('assetNameList');
    let allAssetNames = [];
    let filteredAssetNames = [];

    // Helper: Populate allAssetNames from asset type selection
    function updateAllAssetNames() {
        const assetTypeSelect = document.getElementById('asset_type');
        const selectedType = assetTypeSelect.value;
        
        if (selectedType && window.assetNamesByType && window.assetNamesByType[selectedType]) {
            allAssetNames = window.assetNamesByType[selectedType].map(item => item.name);
        } else {
            allAssetNames = [];
        }
        renderAssetNameOptions('');
    }

    // Helper: Render custom dropdown options
    function renderAssetNameOptions(filter = '') {
        assetNameList.innerHTML = '';
        dropdownItems = [];
        const lowerFilter = filter.trim().toLowerCase();
        
        // Show all available options when no filter is applied
        if (lowerFilter === '') {
            filteredAssetNames = allAssetNames.filter(name => !selectedAssetNames.includes(name));
        } else {
            filteredAssetNames = allAssetNames.filter(name =>
                !selectedAssetNames.includes(name) &&
                name.toLowerCase().includes(lowerFilter)
            );
        }
        
        if (filteredAssetNames.length === 0) {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.textContent = 'No asset names found';
            item.style.color = '#6c757d';
            item.style.fontStyle = 'italic';
            assetNameList.appendChild(item);
        } else {
            filteredAssetNames.forEach((name, index) => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = name;
                item.style.cursor = 'pointer';
                item.dataset.index = index;
                item.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    addAssetNameToSelection(name);
                    assetNameInput.value = '';
                    selectedIndex = -1;
                    // Re-render options to remove the selected item
                    renderAssetNameOptions('');
                    // Keep dropdown open for next selection
                    if (filteredAssetNames.length > 0) {
                        assetNameInput.focus();
                    } else {
                        hideDropdown();
                    }
                };
                assetNameList.appendChild(item);
                dropdownItems.push(item);
            });
        }
        // Reset selection when rendering new options
        selectedIndex = -1;
        updateDropdownSelection();
    }

    // Update dropdown selection highlighting
    function updateDropdownSelection() {
        dropdownItems.forEach((item, index) => {
            if (index === selectedIndex) {
                item.style.backgroundColor = '#007bff';
                item.style.color = 'white';
                item.classList.add('selected');
            } else {
                item.style.backgroundColor = '';
                item.style.color = '';
                item.classList.remove('selected');
            }
        });
    }

    // Show dropdown
    function showDropdown() {
        assetNameDropdown.style.display = 'block';
        renderAssetNameOptions(assetNameInput.value);
    }

    // Hide dropdown
    function hideDropdown() {
        assetNameDropdown.style.display = 'none';
    }

    // On input: filter options
    assetNameInput.addEventListener('input', function() {
        showDropdown();
        renderAssetNameOptions(assetNameInput.value);
    });
    
    // Keep dropdown open when typing
    assetNameInput.addEventListener('keyup', function() {
        if (assetNameInput.value.trim() !== '') {
            showDropdown();
            renderAssetNameOptions(assetNameInput.value);
        }
    });

    // On focus: show all options immediately
    assetNameInput.addEventListener('focus', function() {
        showDropdown();
        renderAssetNameOptions('');
    });

    // On click: also show all options
    assetNameInput.addEventListener('click', function() {
        showDropdown();
        renderAssetNameOptions('');
    });

    // Keyboard navigation variables
    let selectedIndex = -1;
    let dropdownItems = [];

    // On Enter: add asset name as tag
    assetNameInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const val = assetNameInput.value.trim();
            if (val && filteredAssetNames.includes(val)) {
                addAssetNameToSelection(val);
                assetNameInput.value = '';
                selectedIndex = -1;
                renderAssetNameOptions('');
                if (filteredAssetNames.length > 0) {
                    assetNameInput.focus();
                } else {
                    hideDropdown();
                }
            } else if (selectedIndex >= 0 && dropdownItems[selectedIndex]) {
                // Select highlighted item
                const selectedName = dropdownItems[selectedIndex].textContent;
                addAssetNameToSelection(selectedName);
                assetNameInput.value = '';
                selectedIndex = -1;
                renderAssetNameOptions('');
                if (filteredAssetNames.length > 0) {
                    assetNameInput.focus();
                } else {
                    hideDropdown();
                }
            }
        } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            if (dropdownItems.length > 0) {
                selectedIndex = Math.min(selectedIndex + 1, dropdownItems.length - 1);
                updateDropdownSelection();
            }
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (dropdownItems.length > 0) {
                selectedIndex = Math.max(selectedIndex - 1, -1);
                updateDropdownSelection();
            }
        } else if (e.key === 'Escape') {
            e.preventDefault();
            hideDropdown();
            selectedIndex = -1;
        } else if (e.key === 'Backspace' && assetNameInput.value === '') {
            // Remove last tag if input is empty
            if (selectedAssetNames.length > 0) {
                removeAssetNameFromSelection(selectedAssetNames[selectedAssetNames.length - 1]);
            }
        }
    });

    // Hide dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!assetNameInput.contains(e.target) && !assetNameDropdown.contains(e.target)) {
            hideDropdown();
        }
    });
    
    // Prevent dropdown from closing when clicking inside it
    assetNameDropdown.addEventListener('click', function(e) {
        e.stopPropagation();
    });

    // When removing a tag, re-render options
    function addAssetNameToSelection(assetName) {
        if (!selectedAssetNames.includes(assetName)) {
            selectedAssetNames.push(assetName);
            updateSelectedAssetNamesDisplay();
            updateHiddenInput();
        }
    }
    
    function removeAssetNameFromSelection(assetName) {
        const index = selectedAssetNames.indexOf(assetName);
        if (index > -1) {
            selectedAssetNames.splice(index, 1);
            updateSelectedAssetNamesDisplay();
            updateHiddenInput();
        }
    }

    // Update dropdown when asset type changes
    document.getElementById('asset_type').addEventListener('change', function() {
        updateAllAssetNames();
    });





    // Filtering functions for price analysis modal tables
    function filterBuildingTable(buildingFilter) {
        const table = document.getElementById('buildingTable');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        // Show/hide rows based on filter
        rows.forEach(row => {
            const firstCell = row.querySelector('td');
            if (firstCell) {
                const buildingName = firstCell.textContent.trim();
                if (!buildingFilter || buildingName === buildingFilter || buildingName === 'TOTAL') {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        });
        
        // Update totals if filtering
        if (buildingFilter) {
            updateBuildingTotal(buildingFilter);
        } else {
            restoreBuildingTotal();
        }
    }
    
    function filterDepartmentTable(deptFilter) {
        const table = document.querySelector('#priceAnalysisModal .col-md-6:nth-child(2) table');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        // Show/hide rows based on filter
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 2) {
                const deptName = cells[0].textContent.trim(); // First column is department name
                if (!deptFilter) {
                    row.style.display = '';
                } else {
                    // Convert dropdown value format to table format for comparison
                    // Dropdown: "HO-IT", Table: "HO - IT"
                    const formattedFilter = deptFilter.replace('-', ' - ');
                    
                    if (deptName === formattedFilter) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            }
        });
    }
    
    function filterAssetTable(buildingFilter) {
        const table = document.querySelector('#priceAnalysisModal .col-md-12 table');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        // Show/hide rows based on filter
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 6) {
                const buildingName = cells[1].textContent.trim(); // Building column (index 1)
                if (!buildingFilter || buildingName === buildingFilter) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        });
    }
    
    function updateBuildingTotal(buildingFilter) {
        const totalRow = document.querySelector('#buildingTable tbody tr:last-child');
        if (totalRow) {
                    const buildingPrices = {{ chart_data.building_prices|tojson }};
        const buildingCounts = {{ chart_data.building_counts|tojson }};
        const buildingValue = buildingPrices[buildingFilter] || 0;
        const buildingCount = buildingCounts[buildingFilter] || 0;
            const avgValue = buildingCount > 0 ? (buildingValue / buildingCount).toFixed(3) : '0.000';
            
            const cells = totalRow.querySelectorAll('td');
            if (cells.length >= 4) {
                cells[0].textContent = `${buildingFilter} TOTAL`;
                cells[1].textContent = buildingCount;
                cells[2].textContent = buildingValue.toFixed(3);
                cells[3].textContent = avgValue;
            }
        }
    }
    
    function restoreBuildingTotal() {
        const totalRow = document.querySelector('#buildingTable tbody tr:last-child');
        if (totalRow) {
            const totalAssets = Object.values(window.chartData.buildingCounts).reduce((a, b) => a + b, 0);
            const totalValue = window.chartData.totalSystemValue;
            const avgValue = totalAssets > 0 ? (totalValue / totalAssets).toFixed(3) : '0.000';
            
            const cells = totalRow.querySelectorAll('td');
            if (cells.length >= 4) {
                cells[0].textContent = 'TOTAL';
                cells[1].textContent = totalAssets;
                cells[2].textContent = totalValue.toFixed(3);
                cells[3].textContent = avgValue;
            }
        }
    }
    


    function exportPriceAnalysis() {
        const timestamp = new Date().toISOString().slice(0, 19).replace('T', '_');
        const filename = `Asset_Price_Analysis_${timestamp}.xlsx`;
        
        // Create workbook and worksheets
        const workbook = XLSX.utils.book_new();
        
        // System Overview Sheet
        const systemOverviewData = [
            ['ASSET PRICE ANALYSIS REPORT'],
            [''],
            ['Report Generated:', new Date().toLocaleString()],
            ['Total System Value:', `OMR ${window.chartData.totalSystemValue.toFixed(3)}`],
            ['Total Assets:', Object.values(window.chartData.buildingCounts).reduce((a, b) => a + b, 0)],
            [''],
            ['Currency: Omani Rial (OMR)']
        ];
        
        const systemOverviewSheet = XLSX.utils.aoa_to_sheet(systemOverviewData);
        systemOverviewSheet['!cols'] = [{ width: 30 }, { width: 25 }];
        XLSX.utils.book_append_sheet(workbook, systemOverviewSheet, 'System Overview');
        
        // Building Analysis Sheet
        const buildingData = [
            ['BUILDING ANALYSIS'],
            [''],
            ['Building Name', 'Total Assets', 'Total Value (OMR)', 'Average Value per Asset (OMR)'],
            ['', '', '', '']
        ];
        
        Object.entries(window.chartData.buildingPrices).forEach(([building, value]) => {
            const assetCount = window.chartData.buildingCounts[building] || 0;
            const avgValue = assetCount > 0 ? (value / assetCount).toFixed(3) : '0.000';
            buildingData.push([building, assetCount, value.toFixed(3), avgValue]);
        });
        
        // Add totals row
        const totalAssets = Object.values(window.chartData.buildingCounts).reduce((a, b) => a + b, 0);
        const totalValue = window.chartData.totalSystemValue;
        buildingData.push(['', '', '', '']);
        buildingData.push(['TOTAL', totalAssets, totalValue.toFixed(3), (totalValue / totalAssets).toFixed(3)]);
        
        const buildingSheet = XLSX.utils.aoa_to_sheet(buildingData);
        buildingSheet['!cols'] = [{ width: 20 }, { width: 15 }, { width: 20 }, { width: 25 }];
        XLSX.utils.book_append_sheet(workbook, buildingSheet, 'Building Analysis');
        
        // Department Analysis Sheet
        const departmentData = [
            ['DEPARTMENT ANALYSIS'],
            [''],
            ['Building', 'Department', 'Total Assets', 'Total Value (OMR)', 'Average Value per Asset (OMR)'],
            ['', '', '', '', '']
        ];
        
        Object.entries(window.chartData.departmentPrices).forEach(([deptKey, value]) => {
            const [building, department] = deptKey.split('-', 2);
            // Count assets for this department (simplified - you might want to get this from backend)
            const assetCount = 1; // This would need to be calculated properly
            const avgValue = assetCount > 0 ? (value / assetCount).toFixed(3) : '0.000';
            departmentData.push([building, department, assetCount, value.toFixed(3), avgValue]);
        });
        
        // Sort departments by value (highest first)
        departmentData.sort((a, b) => {
            if (a[0] === 'Building' || b[0] === 'Building') return 0;
            return parseFloat(b[3]) - parseFloat(a[3]);
        });
        
        const departmentSheet = XLSX.utils.aoa_to_sheet(departmentData);
        departmentSheet['!cols'] = [{ width: 15 }, { width: 20 }, { width: 15 }, { width: 20 }, { width: 25 }];
        XLSX.utils.book_append_sheet(workbook, departmentSheet, 'Department Analysis');
        
        // Detailed Asset Breakdown Sheet
        const assetData = [
            ['DETAILED ASSET BREAKDOWN'],
            [''],
            ['Asset Name', 'Asset Code', 'Building', 'Department', 'Quantity', 'Unit Price (OMR)', 'Total Value (OMR)', 'Status'],
            ['', '', '', '', '', '', '', '']
        ];
        
        // Get asset data from the current page (this would need to be enhanced to get all assets)
        const assetRows = document.querySelectorAll('.table-responsive table tbody tr');
        assetRows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 10) {
                const name = cells[2].querySelector('strong')?.textContent || '';
                const code = cells[2].querySelector('small')?.textContent || '';
                const building = cells[6]?.textContent || '';
                const department = cells[7]?.textContent || '';
                const quantity = cells[4]?.textContent || '';
                const price = cells[5]?.textContent.replace('OMR ', '') || '0.000';
                const totalValue = (parseFloat(price) * parseInt(quantity)).toFixed(3);
                const status = cells[8]?.querySelector('option:checked')?.textContent || '';
                
                assetData.push([name, code, building, department, quantity, price, totalValue, status]);
            }
        });
        
        const assetSheet = XLSX.utils.aoa_to_sheet(assetData);
        assetSheet['!cols'] = [
            { width: 25 }, { width: 20 }, { width: 15 }, { width: 20 }, 
            { width: 12 }, { width: 18 }, { width: 18 }, { width: 15 }
        ];
        XLSX.utils.book_append_sheet(workbook, assetSheet, 'Asset Details');
        
        // Generate and download the file
        XLSX.writeFile(workbook, filename);
    }
  </script>
  </body>
  </html> </html> 
