<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Asset</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div class="container mt-5">
    <h1 class="mb-4">Add New Asset</h1>
    
    <div class="alert alert-info mb-4">
      <i class="fas fa-info-circle"></i> 
      <strong>Need to add buildings, departments, or users?</strong> 
      <a href="/" class="alert-link">Go to the main page</a> and use the management buttons to set up your infrastructure first.
    </div>
    
    <form method="post">
        <div class="mb-3">
            <label for="name" class="form-label">Asset Name</label>
            <input type="text" class="form-control" id="name" name="name" required>
        </div>
        <div class="mb-3">
            <label for="quantity" class="form-label">Quantity</label>
            <input type="number" class="form-control" id="quantity" name="quantity" min="1" value="1" required>
        </div>
        <div class="mb-3">
            <label for="building" class="form-label">Building</label>
            <select class="form-select" id="building" name="building" required>
                <option value="">Select Building</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="department" class="form-label">Department/Section</label>
            <select class="form-select" id="department" name="department" required>
                <option value="">Select Building First</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="owner" class="form-label">Owner</label>
            <select class="form-select" id="owner" name="owner" required>
                <option value="">Select Department First</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="used_status" class="form-label">Status</label>
            <select class="form-select" id="used_status" name="used_status" required>
                <option value="Not Used">Not Used</option>
                <option value="Used">Used</option>
                <option value="Out of Service">Out of Service</option>
            </select>
        </div>
        <button type="submit" class="btn btn-success">Add Asset</button>
        <a href="/" class="btn btn-secondary">Cancel</a>
    </form>
</div>

<script>
    let buildingsData = [];
    let departmentsData = [];

    // Load buildings from database
    function loadBuildings() {
        fetch('/buildings')
            .then(response => response.json())
            .then(data => {
                buildingsData = data;
                updateBuildingDropdown();
                updateBuildingsList();
                updateDepartmentBuildingDropdown();
            })
            .catch(error => console.error('Error loading buildings:', error));
    }

    // Load departments from database
    function loadDepartments() {
        fetch('/departments')
            .then(response => response.json())
            .then(data => {
                departmentsData = data;
                updateDepartmentsList();
                updateDepartmentFilterDropdown();
            })
            .catch(error => console.error('Error loading departments:', error));
    }

    // Update building dropdown options
    function updateBuildingDropdown() {
        const buildingSelect = document.getElementById('building');
        buildingSelect.innerHTML = '<option value="">Select Building</option>';
        buildingsData.forEach(building => {
            const option = document.createElement('option');
            option.value = building.name;
            option.textContent = building.name;
            buildingSelect.appendChild(option);
        });
    }

    // Update department building dropdown in management modal
    function updateDepartmentBuildingDropdown() {
        const select = document.getElementById('newDepartmentBuilding');
        select.innerHTML = '<option value="">Select Building</option>';
        buildingsData.forEach(building => {
            const option = document.createElement('option');
            option.value = building.id;
            option.textContent = building.name;
            select.appendChild(option);
        });
    }

    // Update buildings list in management modal
    function updateBuildingsList() {
        const buildingsList = document.getElementById('buildingsList');
        buildingsList.innerHTML = '';
        
        buildingsData.forEach(building => {
            const listItem = document.createElement('div');
            listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
            listItem.innerHTML = `
                <span class="building-name" data-id="${building.id}">${building.name}</span>
                <div>
                    <button class="btn btn-sm btn-outline-primary edit-building-btn me-2" data-id="${building.id}" data-name="${building.name}">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-building-btn" data-id="${building.id}" data-name="${building.name}">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            `;
            buildingsList.appendChild(listItem);
        });

        // Add event listeners for edit and delete buttons
        document.querySelectorAll('.edit-building-btn').forEach(btn => {
            btn.addEventListener('click', handleEditBuilding);
        });
        
        document.querySelectorAll('.delete-building-btn').forEach(btn => {
            btn.addEventListener('click', handleDeleteBuilding);
        });
    }

    // Update departments list in management modal
    function updateDepartmentsList() {
        const departmentsList = document.getElementById('departmentsList');
        const filterSelect = document.getElementById('departmentFilterBuilding');
        const selectedBuilding = filterSelect ? filterSelect.value : '';
        
        departmentsList.innerHTML = '';
        
        // Filter departments based on selected building
        let filteredDepartments = departmentsData;
        if (selectedBuilding) {
            filteredDepartments = departmentsData.filter(dept => dept.building_name === selectedBuilding);
        }
        
        if (filteredDepartments.length === 0) {
            departmentsList.innerHTML = '<div class="text-center text-muted p-3">No departments found</div>';
            return;
        }
        
        // Group departments by building
        const departmentsByBuilding = {};
        filteredDepartments.forEach(department => {
            if (!departmentsByBuilding[department.building_name]) {
                departmentsByBuilding[department.building_name] = [];
            }
            departmentsByBuilding[department.building_name].push(department);
        });
        
        // Create organized list
        Object.keys(departmentsByBuilding).sort().forEach(buildingName => {
            if (!selectedBuilding) {
                // Only show building headers when not filtering
                const buildingHeader = document.createElement('div');
                buildingHeader.className = 'list-group-item list-group-item-info fw-bold';
                buildingHeader.innerHTML = `<i class="fas fa-building"></i> ${buildingName}`;
                departmentsList.appendChild(buildingHeader);
            }
            
            departmentsByBuilding[buildingName].forEach(department => {
                const listItem = document.createElement('div');
                listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                listItem.innerHTML = `
                    <div>
                        <span class="department-name fw-bold" data-id="${department.id}">${department.name}</span>
                        ${selectedBuilding ? '' : `<small class="text-muted d-block"><i class="fas fa-building"></i> ${department.building_name}</small>`}
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-primary edit-department-btn me-2" 
                                data-id="${department.id}" 
                                data-name="${department.name}"
                                data-building="${department.building_name}">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-department-btn" 
                                data-id="${department.id}" 
                                data-name="${department.name}"
                                data-building="${department.building_name}">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `;
                departmentsList.appendChild(listItem);
            });
        });

        // Add event listeners for edit and delete buttons
        document.querySelectorAll('.edit-department-btn').forEach(btn => {
            btn.addEventListener('click', handleEditDepartment);
        });
        
        document.querySelectorAll('.delete-department-btn').forEach(btn => {
            btn.addEventListener('click', handleDeleteDepartment);
        });
    }

    // Update department filter dropdown
    function updateDepartmentFilterDropdown() {
        const filterSelect = document.getElementById('departmentFilterBuilding');
        if (!filterSelect) return;
        
        filterSelect.innerHTML = '<option value="">All Buildings</option>';
        
        const uniqueBuildings = [...new Set(departmentsData.map(dept => dept.building_name))].sort();
        uniqueBuildings.forEach(building => {
            const option = document.createElement('option');
            option.value = building;
            option.textContent = building;
            filterSelect.appendChild(option);
        });
        
        // Add change listener
        filterSelect.addEventListener('change', function() {
            updateDepartmentsList();
        });
    }

    // Handle adding new building
    document.getElementById('addBuildingBtn').addEventListener('click', function() {
        const nameInput = document.getElementById('newBuildingName');
        const name = nameInput.value.trim();
        
        if (!name) {
            alert('Please enter a building name.');
            return;
        }

        const formData = new FormData();
        formData.append('name', name);

        fetch('/buildings', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                nameInput.value = '';
                loadBuildings(); // Reload the buildings list
            } else {
                alert(data.error || 'Failed to add building.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to add building.');
        });
    });

    // Handle adding new department
    document.getElementById('addDepartmentBtn').addEventListener('click', function() {
        const nameInput = document.getElementById('newDepartmentName');
        const buildingSelect = document.getElementById('newDepartmentBuilding');
        const name = nameInput.value.trim();
        const buildingId = buildingSelect.value;
        
        if (!name) {
            alert('Please enter a department name.');
            return;
        }

        if (!buildingId) {
            alert('Please select a building.');
            return;
        }

        const formData = new FormData();
        formData.append('name', name);
        formData.append('building_id', buildingId);

        fetch('/departments', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                nameInput.value = '';
                buildingSelect.value = '';
                loadDepartments(); // Reload the departments list
            } else {
                alert(data.error || 'Failed to add department.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to add department.');
        });
    });

    // Handle editing building
    function handleEditBuilding(e) {
        const buildingId = e.currentTarget.getAttribute('data-id');
        const currentName = e.currentTarget.getAttribute('data-name');
        const newName = prompt('Enter new building name:', currentName);
        
        if (newName && newName.trim() !== currentName) {
            const formData = new FormData();
            formData.append('name', newName.trim());

            fetch(`/buildings/${buildingId}`, {
                method: 'PUT',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadBuildings(); // Reload the buildings list
                    loadDepartments(); // Reload departments list to update building names
                } else {
                    alert(data.error || 'Failed to update building.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update building.');
            });
        }
    }

    // Handle editing department
    function handleEditDepartment(e) {
        const departmentId = e.currentTarget.getAttribute('data-id');
        const currentName = e.currentTarget.getAttribute('data-name');
        const buildingName = e.currentTarget.getAttribute('data-building');
        
        const newName = prompt(`Edit department name for "${buildingName}":\n\nCurrent name: ${currentName}\nEnter new name:`, currentName);
        
        if (newName && newName.trim() !== currentName) {
            const formData = new FormData();
            formData.append('name', newName.trim());

            fetch(`/departments/${departmentId}`, {
                method: 'PUT',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadDepartments(); // Reload the departments list
                } else {
                    alert(data.error || 'Failed to update department.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update department.');
            });
        }
    }

    // Handle deleting building
    function handleDeleteBuilding(e) {
        const buildingId = e.currentTarget.getAttribute('data-id');
        const buildingName = e.currentTarget.getAttribute('data-name');
        
        if (confirm(`Are you sure you want to delete "${buildingName}"? This will also delete all its departments.`)) {
            fetch(`/buildings/${buildingId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadBuildings(); // Reload the buildings list
                    loadDepartments(); // Reload departments list
                } else {
                    alert(data.error || 'Failed to delete building.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to delete building.');
            });
        }
    }

    // Handle deleting department
    function handleDeleteDepartment(e) {
        const departmentId = e.currentTarget.getAttribute('data-id');
        const departmentName = e.currentTarget.getAttribute('data-name');
        const buildingName = e.currentTarget.getAttribute('data-building');
        
        if (confirm(`Are you sure you want to delete "${departmentName}" from "${buildingName}"?`)) {
            fetch(`/departments/${departmentId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadDepartments(); // Reload the departments list
                } else {
                    alert(data.error || 'Failed to delete department.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to delete department.');
            });
        }
    }

    // ===== USER MODAL FUNCTIONS =====

    // Load data for user modal
    function loadUserModalData() {
        loadUserModalBuildings();
        loadUserModalUsers();
        loadUserModalFilterDropdown();
    }

    // Load buildings for user modal
    function loadUserModalBuildings() {
        fetch('/buildings')
            .then(response => response.json())
            .then(buildings => {
                const buildingSelect = document.getElementById('userModalBuilding');
                buildingSelect.innerHTML = '<option value="">Select Building</option>';
                
                buildings.forEach(building => {
                    const option = document.createElement('option');
                    option.value = building.id;
                    option.textContent = building.name;
                    buildingSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading buildings for user modal:', error);
            });
    }

    // Update departments in user modal based on building
    function updateUserModalDepartments(buildingId) {
        const departmentSelect = document.getElementById('userModalDepartment');
        
        if (!buildingId) {
            departmentSelect.innerHTML = '<option value="">Select Building First</option>';
            return;
        }
        
        departmentSelect.innerHTML = '<option value="">Loading...</option>';
        
        fetch(`/departments?building_id=${buildingId}`)
            .then(response => response.json())
            .then(departments => {
                departmentSelect.innerHTML = '<option value="">Select Department</option>';
                
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.id;
                    option.textContent = dept.name;
                    departmentSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading departments for user modal:', error);
                departmentSelect.innerHTML = '<option value="">Error loading departments</option>';
            });
    }

    // Load users for user modal
    function loadUserModalUsers(filterDepartmentId = '') {
        const url = filterDepartmentId ? `/users?department_id=${filterDepartmentId}` : '/users';
        
        fetch(url)
            .then(response => response.json())
            .then(users => {
                const usersList = document.getElementById('userModalList');
                usersList.innerHTML = '';
                
                if (users.length === 0) {
                    usersList.innerHTML = '<div class="list-group-item text-muted">No users found.</div>';
                    return;
                }
                
                // Group users by building and department
                const usersByGroup = {};
                users.forEach(user => {
                    const key = `${user.building_name} - ${user.department_name}`;
                    if (!usersByGroup[key]) {
                        usersByGroup[key] = [];
                    }
                    usersByGroup[key].push(user);
                });
                
                // Display users grouped by department
                Object.keys(usersByGroup).sort().forEach(groupKey => {
                    // Add group header
                    const groupHeader = document.createElement('div');
                    groupHeader.className = 'list-group-item list-group-item-light fw-bold';
                    groupHeader.innerHTML = `<i class="fas fa-building"></i> ${groupKey}`;
                    usersList.appendChild(groupHeader);
                    
                    // Add users in this group
                    usersByGroup[groupKey].sort((a, b) => a.name.localeCompare(b.name)).forEach(user => {
                        const userItem = document.createElement('div');
                        userItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                        userItem.innerHTML = `
                            <span><i class="fas fa-user"></i> ${user.name}</span>
                            <div>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="handleEditUserModal(event)" 
                                        data-id="${user.id}" data-name="${user.name}" data-department="${user.department_name}" 
                                        title="Edit User">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="handleDeleteUserModal(event)" 
                                        data-id="${user.id}" data-name="${user.name}" data-department="${user.department_name}" 
                                        title="Delete User">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        usersList.appendChild(userItem);
                    });
                });
            })
            .catch(error => {
                console.error('Error loading users for modal:', error);
            });
    }

    // Load filter dropdown for user modal
    function loadUserModalFilterDropdown() {
        fetch('/departments')
            .then(response => response.json())
            .then(departments => {
                const filterSelect = document.getElementById('userModalFilterDepartment');
                filterSelect.innerHTML = '<option value="">All Departments</option>';
                
                // Group departments by building
                const departmentsByBuilding = {};
                departments.forEach(dept => {
                    if (!departmentsByBuilding[dept.building_name]) {
                        departmentsByBuilding[dept.building_name] = [];
                    }
                    departmentsByBuilding[dept.building_name].push(dept);
                });
                
                // Add options grouped by building
                Object.keys(departmentsByBuilding).sort().forEach(buildingName => {
                    const group = document.createElement('optgroup');
                    group.label = buildingName;
                    
                    departmentsByBuilding[buildingName].sort((a, b) => a.name.localeCompare(b.name)).forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept.id;
                        option.textContent = dept.name;
                        group.appendChild(option);
                    });
                    
                    filterSelect.appendChild(group);
                });
            })
            .catch(error => {
                console.error('Error loading departments for filter:', error);
            });
    }

    // Handle adding user from modal
    function handleAddUserModal() {
        const buildingId = document.getElementById('userModalBuilding').value;
        const departmentId = document.getElementById('userModalDepartment').value;
        const name = document.getElementById('userModalName').value.trim();
        
        if (!buildingId) {
            alert('Please select a building.');
            return;
        }
        
        if (!departmentId) {
            alert('Please select a department.');
            return;
        }
        
        if (!name) {
            alert('Please enter a user name.');
            return;
        }
        
        fetch('/users', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: name,
                department_id: parseInt(departmentId)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.id) {
                document.getElementById('userModalName').value = '';
                document.getElementById('userModalBuilding').value = '';
                document.getElementById('userModalDepartment').value = '';
                document.getElementById('userModalDepartment').innerHTML = '<option value="">Select Building First</option>';
                loadUserModalUsers(); // Reload the users list
                loadOwnersForDepartment(document.getElementById('department').value); // Refresh owner dropdown
                alert(`âœ… User "${name}" registered successfully!`);
            } else {
                alert(data.error || 'Failed to register user.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to register user.');
        });
    }

    // Handle editing user from modal
    function handleEditUserModal(e) {
        const userId = e.currentTarget.getAttribute('data-id');
        const currentName = e.currentTarget.getAttribute('data-name');
        const departmentName = e.currentTarget.getAttribute('data-department');
        
        const newName = prompt(`Edit user name for "${departmentName}" department:`, currentName);
        if (newName && newName.trim() && newName.trim() !== currentName) {
            fetch(`/users/${userId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: newName.trim()
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadUserModalUsers(); // Reload the users list
                    loadOwnersForDepartment(document.getElementById('department').value); // Refresh owner dropdown
                } else {
                    alert(data.error || 'Failed to update user.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update user.');
            });
        }
    }

    // Handle deleting user from modal
    function handleDeleteUserModal(e) {
        const userId = e.currentTarget.getAttribute('data-id');
        const userName = e.currentTarget.getAttribute('data-name');
        const departmentName = e.currentTarget.getAttribute('data-department');
        
        if (confirm(`Are you sure you want to delete "${userName}" from "${departmentName}"?`)) {
            fetch(`/users/${userId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadUserModalUsers(); // Reload the users list
                    loadOwnersForDepartment(document.getElementById('department').value); // Refresh owner dropdown
                } else {
                    alert(data.error || 'Failed to delete user.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to delete user.');
            });
        }
    }

    // Initialize data on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadBuildings();
        loadDepartments();
    });

    // Handle Enter key in new building input
    document.getElementById('newBuildingName').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('addBuildingBtn').click();
        }
    });

    // Handle Enter key in new department input
    document.getElementById('newDepartmentName').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('addDepartmentBtn').click();
        }
    });

    document.getElementById('building').addEventListener('change', function() {
        const selectedBuilding = this.value;
        const departmentSelect = document.getElementById('department');
        departmentSelect.innerHTML = '<option value="">Select Department/Section</option>';
        
        if (selectedBuilding) {
            // Find the building ID
            const building = buildingsData.find(b => b.name === selectedBuilding);
            if (building) {
                // Load departments for this building
                fetch(`/departments?building_id=${building.id}`)
                    .then(response => response.json())
                    .then(departments => {
                        departments.forEach(department => {
                            const option = document.createElement('option');
                            option.value = department.name;
                            option.textContent = department.name;
                            departmentSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error loading departments:', error));
            }
        }
    });



    // Handle department change to update owner dropdown
    document.getElementById('department').addEventListener('change', function() {
        loadOwnersForDepartment(this.value);
    });

    // Load owners for selected department
    function loadOwnersForDepartment(departmentName) {
        const ownerSelect = document.getElementById('owner');
        
        // Clear existing options
        ownerSelect.innerHTML = '<option value="">Loading...</option>';
        
        if (!departmentName) {
            ownerSelect.innerHTML = '<option value="">Select Department First</option>';
            return;
        }
        
        // Find department ID by name
        fetch('/departments')
            .then(response => response.json())
            .then(departments => {
                const department = departments.find(d => d.name === departmentName);
                if (!department) {
                    ownerSelect.innerHTML = '<option value="">Department not found</option>';
                    return;
                }
                
                // Fetch users for this department
                return fetch(`/users?department_id=${department.id}`);
            })
            .then(response => response.json())
            .then(users => {
                ownerSelect.innerHTML = '<option value="">Select Owner</option>';
                
                if (users.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No users in this department';
                    option.disabled = true;
                    ownerSelect.appendChild(option);
                } else {
                    users.sort((a, b) => a.name.localeCompare(b.name)).forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.name;
                        option.textContent = user.name;
                        ownerSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading owners:', error);
                ownerSelect.innerHTML = '<option value="">Error loading owners</option>';
            });
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 